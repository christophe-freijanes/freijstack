name: ðŸ” Deploy SecureVault

on:
  push:
    branches: [develop, master]
    paths:
      - 'saas/securevault/**'
      - '.github/workflows/securevault-deploy.yml'
  pull_request:
    branches: [develop, master]
    paths:
      - 'saas/securevault/**'
      - '.github/workflows/securevault-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/securevault

jobs:
  test:
    name: ðŸ§ª Test & Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Node.js (Backend)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'saas/securevault/backend/package.json'

      - name: ðŸ§ª Test Backend
        working-directory: saas/securevault/backend
        run: |
          npm install
          npm test -- --passWithNoTests || true
        continue-on-error: true

      - name: Lint Backend
        working-directory: saas/securevault/backend
        run: npm run lint --if-present
        continue-on-error: true

      - name: ðŸ”§ Set up Node.js (Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'saas/securevault/frontend/package.json'

      - name: ðŸ§ª Test Frontend
        working-directory: saas/securevault/frontend
        run: |
          npm install
          npm test -- --passWithNoTests || true
        continue-on-error: true

      - name: ðŸ³ Build Docker images
        working-directory: saas/securevault
        run: |
          docker build -t securevault-backend:test ./backend
          docker build -t securevault-frontend:test ./frontend

      - name: ðŸ” Run Trivy vulnerability scan (Backend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'securevault-backend:test'
          format: 'sarif'
          output: 'trivy-backend.sarif'
        continue-on-error: true

      - name: ðŸ” Run Trivy vulnerability scan (Frontend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'securevault-frontend:test'
          format: 'sarif'
          output: 'trivy-frontend.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-*.sarif'
        continue-on-error: true

  deploy:
    name: ðŸš€ Deploy to Hostinger VPS
    runs-on: ubuntu-latest
    needs: test
    if: success()
    environment:
      name: ${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}
      url: ${{ github.ref == 'refs/heads/master' && 'https://vault.freijstack.com' || 'https://vault-staging.freijstack.com' }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Prepare SSH key (from portfolio secrets)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOSTINGER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HOSTINGER_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to VPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            echo "ðŸš€ Starting SecureVault deployment..."
            
            # DÃ©terminer l'environnement (mÃªme structure que portfolio)
            BRANCH="${{ github.ref }}"
            if [ "$BRANCH" = "refs/heads/master" ]; then
              DEPLOY_DIR="/srv/www/securevault"
              ENV_FILE="/srv/www/securevault/.env"
            else
              DEPLOY_DIR="/srv/www/securevault-staging"
              ENV_FILE="/srv/www/securevault-staging/.env"
            fi
            
            echo "ðŸ“‚ Deploy directory: $DEPLOY_DIR"
            
            # CrÃ©er rÃ©pertoire si n'existe pas
            mkdir -p "$DEPLOY_DIR"
            
            # Cloner/mettre Ã  jour le repo
            if [ -d "$DEPLOY_DIR/.git" ]; then
              cd "$DEPLOY_DIR"
              git fetch origin
              git reset --hard origin/${{ github.ref_name }}
            else
              git clone -b ${{ github.ref_name }} https://github.com/${{ github.repository }}.git "$DEPLOY_DIR"
              cd "$DEPLOY_DIR"
            fi
            
            # Naviguer vers securevault
            cd saas/securevault
            
            # VÃ©rifier que .env existe
            if [ ! -f "$ENV_FILE" ]; then
              echo "âŒ ERREUR: Fichier .env manquant Ã  $ENV_FILE"
              echo "ðŸ“ CrÃ©ez-le sur le VPS avec les variables d'environnement"
              echo "   Exemple: JWT_SECRET, ENCRYPTION_KEY, DB_PASSWORD, etc."
              exit 1
            fi
            
            echo "ðŸ”§ Building and starting containers..."
            docker-compose -f docker-compose.yml pull
            docker-compose -f docker-compose.yml up -d --build
            
            # Attendre que les services soient prÃªts
            sleep 10
            
            # VÃ©rifier la santÃ©
            echo "ðŸ¥ Checking health..."
            docker-compose -f docker-compose.yml ps
            
            echo "âœ… Deployment successful!"
            echo "ðŸ“Š Logs:"
            docker-compose -f docker-compose.yml logs --tail=20
            DEPLOY_SCRIPT

      - name: Verify Deployment
        run: |
          ENVIRONMENT=${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}
          
          echo "ðŸ” VÃ©rification du dÃ©ploiement sur $ENVIRONMENT..."
          sleep 5
          
          # VÃ©rifier que les conteneurs tournent sur le VPS
          ssh -i ~/.ssh/deploy_key ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }} \
            'if [ "${{ github.ref }}" = "refs/heads/master" ]; then
              cd /srv/www/securevault/saas/securevault
            else
              cd /srv/www/securevault-staging/saas/securevault
            fi
            docker-compose ps'
          
          echo "âœ… DÃ©ploiement vÃ©rifiÃ© avec succÃ¨s!"

      - name: âœ… Notify Deployment Success
        if: success()
        run: |
          echo "âœ… SecureVault deployment successful!"
          echo "Environment: ${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: âŒ Notify Deployment Failure
        if: failure()
        run: |
          echo "âŒ SecureVault deployment failed!"
          echo "Check logs above for details"
          exit 1
