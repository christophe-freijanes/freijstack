name: üîê Deploy SecureVault

on:
  push:
    branches: [develop, master]
    paths:
      - 'saas/securevault/**'
      - '.github/workflows/securevault-deploy.yml'
  pull_request:
    branches: [develop, master]
    paths:
      - 'saas/securevault/**'
      - '.github/workflows/securevault-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/securevault

jobs:
  validate:
    name: ‚úÖ Validate VPS Configuration
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: üåê Check DNS Configuration
        run: |
          echo "üîç Checking DNS records..."
          
          # Fonction pour v√©rifier un DNS
          check_dns() {
            DOMAIN=$1
            echo "Checking $DOMAIN..."
            if dig +short $DOMAIN | grep -q '[0-9]'; then
              IP=$(dig +short $DOMAIN | head -n1)
              echo "‚úÖ $DOMAIN ‚Üí $IP"
              return 0
            else
              echo "‚ùå $DOMAIN not configured"
              return 1
            fi
          }
          
          ENV=${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}
          FAILED=0
          
          if [ "$ENV" = "production" ]; then
            check_dns "vault.freijstack.com" || FAILED=1
            check_dns "vault-api.freijstack.com" || FAILED=1
          else
            check_dns "vault-staging.freijstack.com" || FAILED=1
            check_dns "vault-api-staging.freijstack.com" || FAILED=1
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "‚ö†Ô∏è Some DNS records are missing. Please configure them:"
            echo "   - Add A records pointing to your VPS IP"
            echo "   - Wait 5-10 minutes for propagation"
            exit 1
          fi
          
          echo "‚úÖ All DNS records configured correctly"

      - name: üîç Check VPS Prerequisites
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} << 'VPS_CHECK'
            set -e
            echo "üîç Checking VPS configuration..."
            
            # D√©terminer l'environnement
            if [ "${{ github.ref }}" = "refs/heads/master" ]; then
              ENV="production"
              ENV_FILE="/srv/www/securevault/.env"
            else
              ENV="staging"
              ENV_FILE="/srv/www/securevault-staging/.env"
            fi
            
            echo "Environment: $ENV"
            echo ""
            
            # 1. V√©rifier Docker
            echo "1Ô∏è‚É£ Checking Docker..."
            if command -v docker &> /dev/null; then
              DOCKER_VERSION=$(docker --version)
              echo "‚úÖ Docker installed: $DOCKER_VERSION"
            else
              echo "‚ùå Docker not installed"
              exit 1
            fi
            
            # 2. V√©rifier Docker Compose
            echo ""
            echo "2Ô∏è‚É£ Checking Docker Compose..."
            if docker compose version &> /dev/null; then
              COMPOSE_VERSION=$(docker compose version)
              echo "‚úÖ Docker Compose installed: $COMPOSE_VERSION"
            else
              echo "‚ùå Docker Compose not installed"
              exit 1
            fi
            
            # 3. V√©rifier le r√©seau web
            echo ""
            echo "3Ô∏è‚É£ Checking Docker network 'web'..."
            if docker network ls | grep -q "web"; then
              echo "‚úÖ Network 'web' exists"
            else
              echo "‚ö†Ô∏è Network 'web' not found, creating it..."
              docker network create web
              echo "‚úÖ Network 'web' created successfully"
            fi
            
            # 4. V√©rifier Traefik
            echo ""
            echo "4Ô∏è‚É£ Checking Traefik..."
            if docker ps --format '{{.Names}}' | grep -q "traefik"; then
              TRAEFIK_STATUS=$(docker ps --filter "name=traefik" --format "{{.Status}}")
              echo "‚úÖ Traefik is running: $TRAEFIK_STATUS"
            else
              echo "‚ö†Ô∏è Traefik not running"
              echo "   Start it with: cd base-infra && docker-compose up -d"
              exit 1
            fi
            
            # 5. V√©rifier le fichier .env
            echo ""
            echo "5Ô∏è‚É£ Checking .env file..."
            if [ -f "$ENV_FILE" ]; then
              echo "‚úÖ .env file exists at $ENV_FILE"
              
              # V√©rifier les variables requises
              MISSING=""
              for VAR in DB_PASSWORD JWT_SECRET ENCRYPTION_KEY; do
                if ! grep -q "^${VAR}=" "$ENV_FILE"; then
                  MISSING="$MISSING $VAR"
                fi
              done
              
              if [ -n "$MISSING" ]; then
                echo "‚ö†Ô∏è Missing variables in .env:$MISSING"
                exit 1
              else
                echo "‚úÖ All required variables present"
              fi
            else
              echo "‚ö†Ô∏è .env file not found, creating it with generated secrets..."
              
              # Cr√©er le r√©pertoire si n√©cessaire
              mkdir -p $(dirname "$ENV_FILE")
              
              # G√©n√©rer les secrets
              DB_PASS=$(openssl rand -hex 32)
              JWT_SEC=$(openssl rand -hex 32)
              ENC_KEY=$(openssl rand -hex 32)
              
              # Cr√©er le fichier .env avec les secrets g√©n√©r√©s
              {
                echo "# Auto-generated secrets for SecureVault"
                echo "# Generated on $(date)"
                echo ""
                echo "DB_PASSWORD=$DB_PASS"
                echo "JWT_SECRET=$JWT_SEC"
                echo "ENCRYPTION_KEY=$ENC_KEY"
              } > "$ENV_FILE"
              
              chmod 600 "$ENV_FILE"
              echo "‚úÖ .env file created at $ENV_FILE with secure permissions"
            fi
            
            # 6. V√©rifier les permissions
            echo ""
            echo "6Ô∏è‚É£ Checking .env permissions..."
            PERMS=$(stat -c %a "$ENV_FILE" 2>/dev/null || stat -f %A "$ENV_FILE")
            if [ "$PERMS" = "600" ]; then
              echo "‚úÖ .env permissions are secure (600)"
            else
              echo "‚ö†Ô∏è .env permissions are $PERMS (should be 600)"
              echo "   Fix with: chmod 600 $ENV_FILE"
            fi
            
            echo ""
            echo "‚úÖ All VPS prerequisites validated for $ENV!"
          VPS_CHECK

      - name: ‚úÖ Validation Summary
        if: success()
        run: |
          echo "‚úÖ VPS Configuration Validated Successfully!"
          echo ""
          echo "Environment: ${{ github.ref == 'refs/heads/master' && 'Production' || 'Staging' }}"
          echo "Ready for deployment üöÄ"

      - name: ‚ùå Validation Failed
        if: failure()
        run: |
          echo "‚ùå VPS Configuration Validation Failed"
          echo ""
          echo "Please fix the issues above before deploying."
          echo "Review the logs for specific error messages."
          exit 1

  test:
    name: üß™ Test & Build
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
      security-events: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Node.js (Backend)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'saas/securevault/backend/package.json'

      - name: üß™ Test Backend
        working-directory: saas/securevault/backend
        run: |
          npm install
          npm test -- --passWithNoTests || true
        continue-on-error: true

      - name: Lint Backend
        working-directory: saas/securevault/backend
        run: npm run lint --if-present
        continue-on-error: true

      - name: üîß Set up Node.js (Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'saas/securevault/frontend/package.json'

      - name: üß™ Test Frontend
        working-directory: saas/securevault/frontend
        run: |
          npm install
          npm test -- --passWithNoTests || true
        continue-on-error: true

      - name: üê≥ Build Docker images
        working-directory: saas/securevault
        run: |
          docker build -t securevault-backend:test ./backend
          docker build -t securevault-frontend:test ./frontend

      - name: üîç Run Trivy vulnerability scan (Backend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'securevault-backend:test'
          format: 'sarif'
          output: 'trivy-backend.sarif'
        continue-on-error: true

      - name: üîç Run Trivy vulnerability scan (Frontend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'securevault-frontend:test'
          format: 'sarif'
          output: 'trivy-frontend.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security (Backend)
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-backend.sarif'
          category: 'securevault-backend'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security (Frontend)
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-frontend.sarif'
          category: 'securevault-frontend'
        continue-on-error: true

  deploy:
    name: üöÄ Deploy to Hostinger VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')
    environment:
      name: ${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}
      url: ${{ github.ref == 'refs/heads/master' && 'https://vault.freijstack.com' || 'https://vault-staging.freijstack.com' }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: üöÄ Deploy to VPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            echo "üöÄ Starting SecureVault deployment..."
            
            # D√©terminer l'environnement (m√™me structure que portfolio)
            BRANCH="${{ github.ref }}"
            if [ "$BRANCH" = "refs/heads/master" ]; then
              DEPLOY_DIR="/srv/www/securevault"
              ENV_FILE="/srv/www/securevault/.env"
            else
              DEPLOY_DIR="/srv/www/securevault-staging"
              ENV_FILE="/srv/www/securevault-staging/.env"
            fi
            
            echo "üìÇ Deploy directory: $DEPLOY_DIR"
            
            # Cloner/mettre √† jour le repo
            if [ -d "$DEPLOY_DIR/.git" ]; then
              echo "‚úÖ Repository already exists, pulling latest changes..."
              cd "$DEPLOY_DIR"
              git fetch origin
              git reset --hard origin/${{ github.ref_name }}
              git clean -fd
            else
              echo "üì• Cloning repository for the first time..."
              # Supprimer le r√©pertoire s'il existe mais n'est pas un repo Git
              if [ -d "$DEPLOY_DIR" ]; then
                echo "üßπ Cleaning existing directory..."
                rm -rf "$DEPLOY_DIR"
              fi
              git clone -b ${{ github.ref_name }} https://github.com/${{ github.repository }}.git "$DEPLOY_DIR"
              cd "$DEPLOY_DIR"
            fi
            
            # Naviguer vers securevault
            cd saas/securevault
            
            # V√©rifier que .env existe
            if [ ! -f "$ENV_FILE" ]; then
              echo "‚ùå ERREUR: Fichier .env manquant √† $ENV_FILE"
              echo "üìù Cr√©ez-le sur le VPS avec les variables d'environnement"
              echo "   Exemple: JWT_SECRET, ENCRYPTION_KEY, DB_PASSWORD, etc."
              exit 1
            fi
            
            echo "üîß Building and starting containers..."
            docker compose -f docker-compose.yml pull
            docker compose -f docker-compose.yml up -d --build
            
            # Attendre que les services soient pr√™ts
            sleep 10
            
            # V√©rifier la sant√©
            echo "üè• Checking health..."
            docker compose -f docker-compose.yml ps
            
            echo "‚úÖ Deployment successful!"
            echo "üìä Logs:"
            docker compose -f docker-compose.yml logs --tail=20
            DEPLOY_SCRIPT

      - name: Verify Deployment
        run: |
          ENVIRONMENT=${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}
          
          echo "üîç V√©rification du d√©ploiement sur $ENVIRONMENT..."
          sleep 5
          
          # V√©rifier que les conteneurs tournent sur le VPS
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'if [ "${{ github.ref }}" = "refs/heads/master" ]; then
              cd /srv/www/securevault/saas/securevault
            else
              cd /srv/www/securevault-staging/saas/securevault
            fi
            docker compose ps'
          
          echo "‚úÖ D√©ploiement v√©rifi√© avec succ√®s!"

      - name: ‚úÖ Notify Deployment Success
        if: success()
        run: |
          echo "‚úÖ SecureVault deployment successful!"
          echo "Environment: ${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: ‚ùå Notify Deployment Failure
        if: failure()
        run: |
          echo "‚ùå SecureVault deployment failed!"
          echo "Check logs above for details"
          exit 1
