name: üöÄ SaaS ‚Ä¢ Portfolio Deploy (Production)

on:
  # üîÅ Auto-deploy after successful build on master
  workflow_run:
    workflows: ["üèóÔ∏è Build & Push Portfolio"]
    types: [completed]

  # ‚ñ∂Ô∏è Manual trigger (always prod)
  workflow_dispatch: {}

jobs:
  deploy-production:
    name: üöÄ Deploy Portfolio (Production)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'master'
      )

    uses: ./.github/workflows/00-core-full-deploy.yml

    with:
      app_name: "portfolio"
      environment: "production"
      deploy_dir: "/srv/www/portfolio"
      project_path: "saas/portfolio"
      docker_compose_file: "docker-compose.prod.yml"
      run_migrations: false

    secrets:
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      VPS_SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
      VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}

      REGISTRY_USER_PROD: ${{ secrets.REGISTRY_USER_PROD }}
      REGISTRY_PASSWORD_PROD: ${{ secrets.REGISTRY_PASSWORD_PROD }}
