name: üîÑ Rotate Secrets (Monthly)

on:
  schedule:
    # Run on the 1st of each month at 2 AM UTC (useful for DB_PASSWORD)
    - cron: '0 2 1 * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rotate secrets for'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      secret_type:
        description: 'Which secrets to rotate'
        required: true
        default: 'db_password'
        type: choice
        options:
          - db_password
          - all

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # Paths (aligned with securevault-deploy.yml)
  PROJECT_PATH: saas/securevault
  VPS_DEPLOY_DIR_PROD: /srv/www/securevault
  VPS_DEPLOY_DIR_STAGING: /srv/www/securevault-staging
  VPS_ENV_FILE_PROD: /srv/www/securevault/.env
  VPS_ENV_FILE_STAGING: /srv/www/securevault-staging/.env
  VPS_BACKUP_DIR_PROD: /srv/www/securevault/backups
  VPS_BACKUP_DIR_STAGING: /srv/www/securevault-staging/backups

jobs:
  rotate-secrets:
    name: üîë Rotate Secrets
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: üîí Mask sensitive values
        run: |
          echo "::add-mask::${{ secrets.VPS_SSH_USER }}"
          echo "::add-mask::${{ secrets.VPS_SSH_HOST }}"
          echo "::add-mask::${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"

      - name: üåç Determine environment
        id: env
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: üîÑ Rotate secrets on VPS
        env:
          TARGET_ENV: ${{ github.event.inputs.environment || 'staging' }}
          SECRET_TYPE: ${{ github.event.inputs.secret_type || 'db_password' }}
        run: |
          # D√©terminer les chemins selon l'environnement
          if [ "$TARGET_ENV" = "production" ]; then
            ENV_FILE="${{ env.VPS_ENV_FILE_PROD }}"
            COMPOSE_DIR="${{ env.VPS_DEPLOY_DIR_PROD }}/${{ env.PROJECT_PATH }}"
            BACKUP_DIR="${{ env.VPS_BACKUP_DIR_PROD }}"
          else
            ENV_FILE="${{ env.VPS_ENV_FILE_STAGING }}"
            COMPOSE_DIR="${{ env.VPS_DEPLOY_DIR_STAGING }}/${{ env.PROJECT_PATH }}"
            BACKUP_DIR="${{ env.VPS_BACKUP_DIR_STAGING }}"
          fi

          ssh -i ~/.ssh/deploy_key "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}" \
            "TARGET_ENV=\"$TARGET_ENV\" SECRET_TYPE=\"$SECRET_TYPE\" ENV_FILE=\"$ENV_FILE\" COMPOSE_DIR=\"$COMPOSE_DIR\" BACKUP_DIR=\"$BACKUP_DIR\" bash -s" \
            << 'ROTATE_SCRIPT'

          set -e

          echo "üîÑ Starting secret rotation..."
          echo "Environment: $TARGET_ENV"
          echo "Secret type: $SECRET_TYPE"

          # Create backup
          mkdir -p "$BACKUP_DIR"
          BACKUP_FILE="\$BACKUP_DIR/.env.backup.\$(date +%Y%m%d_%H%M%S)"
          cp "\$ENV_FILE" "\$BACKUP_FILE"
          echo "‚úÖ Backup: \$BACKUP_FILE"

          # Generate new secrets
          NEW_DB_PASSWORD=\$(tr -dc 'A-Za-z0-9!@#\$%^&*' < /dev/urandom | head -c 24)
          NEW_JWT_SECRET=\$(tr -dc 'A-Za-z0-9+/=' < /dev/urandom | head -c 44)
          NEW_ENCRYPTION_KEY=\$(openssl rand -hex 32 2>/dev/null || echo "fallback_key_\$(date +%s)")

          echo "üîë Generated new secrets"

          # Update .env
          if [ "$SECRET_TYPE" = "all" ] || [ "$SECRET_TYPE" = "db_password" ]; then
            sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=\$NEW_DB_PASSWORD/" "\$ENV_FILE"
            sed -i "s/POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=\$NEW_DB_PASSWORD/" "\$ENV_FILE"
            echo "‚úÖ Updated DB_PASSWORD and POSTGRES_PASSWORD"
          fi

          if [ "$SECRET_TYPE" = "all" ]; then
            sed -i "s/JWT_SECRET=.*/JWT_SECRET=\$NEW_JWT_SECRET/" "\$ENV_FILE"
            sed -i "s/ENCRYPTION_KEY=.*/ENCRYPTION_KEY=\$NEW_ENCRYPTION_KEY/" "\$ENV_FILE"
            echo "‚úÖ Updated JWT_SECRET and ENCRYPTION_KEY"

            # Note: Changing JWT_SECRET will invalidate all existing tokens
            echo "‚ö†Ô∏è  WARNING: JWT_SECRET changed - users will need to re-login"
          fi

          # Restart containers
          cd "\$COMPOSE_DIR"
          docker compose restart backend
          sleep 5

          # Verify
          if docker compose ps | grep -q "Up"; then
            echo "‚úÖ Containers restarted successfully"
          else
            echo "‚ùå Containers failed to restart - restoring backup"
            cp "\$BACKUP_FILE" "\$ENV_FILE"
            docker compose restart backend
            exit 1
          fi

          echo "‚úÖ Secret rotation completed"
          ROTATE_SCRIPT

      - name: ‚úÖ Notify success
        if: success()
        run: |
          echo "‚úÖ Secret rotation successful!"
          echo "Environment: ${{ steps.env.outputs.environment }}"
          echo "Type: ${{ github.event.inputs.secret_type || 'db_password' }}"

      - name: ‚ùå Notify failure
        if: failure()
        run: |
          echo "‚ùå Secret rotation failed!"
          echo "Check the VPS logs and restore from backup if needed"
          exit 1

  notify:
    name: üì¢ Notify Status
    runs-on: ubuntu-latest
    needs: [rotate-secrets]
    if: always()

    steps:
      - name: Check rotation status
        run: |
          ENV="${{ github.event.inputs.environment || 'staging' }}"
          TYPE="${{ github.event.inputs.secret_type || 'db_password' }}"

          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "üîÑ Scheduled Secret Rotation (Monthly)"
            echo "Environment: staging (default)"
            echo "Type: db_password (default)"
          else
            echo "üîÑ Manual Secret Rotation"
            echo "Environment: $ENV"
            echo "Type: $TYPE"
          fi

      - name: ‚úÖ Rotation Success
        if: ${{ needs.rotate-secrets.result == 'success' }}
        run: |
          echo "‚úÖ Secret rotation completed successfully!"
          echo "üîê Secrets have been regenerated and services restarted"
          echo "üìù Backup created before rotation"

      - name: ‚ùå Rotation Failed
        if: ${{ needs.rotate-secrets.result == 'failure' }}
        run: |
          echo "‚ùå Secret rotation failed!"
          echo "‚ö†Ô∏è Check VPS logs and backup files"
          echo "üìã Backup location: /srv/www/securevault*/.env.backup.*"
