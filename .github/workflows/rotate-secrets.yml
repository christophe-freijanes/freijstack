name: üîÑ Rotate Secrets (Monthly)

on:
  schedule:
    # Run on the 1st of each month at 2 AM UTC (useful for DB_PASSWORD)
    - cron: '0 2 1 * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rotate secrets for'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      secret_type:
        description: 'Which secrets to rotate'
        required: true
        default: 'db_password'
        type: choice
        options:
          - db_password
          - all

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  rotate-secrets:
    name: Rotate Secrets
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOSTINGER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HOSTINGER_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Rotate secrets on VPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }} << 'ROTATE_SCRIPT'
          
          set -e
          
          ENVIRONMENT="${{ steps.env.outputs.environment }}"
          SECRET_TYPE="${{ github.event.inputs.secret_type || 'db_password' }}"
          
          echo "üîÑ Starting secret rotation..."
          echo "Environment: $ENVIRONMENT"
          echo "Secret type: $SECRET_TYPE"
          
          # Determine paths
          if [ "$ENVIRONMENT" = "production" ]; then
            ENV_FILE="/srv/www/securevault/saas/securevault/.env"
            COMPOSE_DIR="/srv/www/securevault/saas/securevault"
            BACKUP_DIR="/srv/www/securevault/backups"
          else
            ENV_FILE="/srv/www/securevault-staging/saas/securevault/.env"
            COMPOSE_DIR="/srv/www/securevault-staging/saas/securevault"
            BACKUP_DIR="/srv/www/securevault-staging/backups"
          fi
          
          # Create backup
          mkdir -p "$BACKUP_DIR"
          BACKUP_FILE="$BACKUP_DIR/.env.backup.$(date +%Y%m%d_%H%M%S)"
          cp "$ENV_FILE" "$BACKUP_FILE"
          echo "‚úÖ Backup: $BACKUP_FILE"
          
          # Generate new secrets (simple version without random, in actual impl would use better method)
          NEW_DB_PASSWORD=$(tr -dc 'A-Za-z0-9!@#$%^&*' < /dev/urandom | head -c 24)
          NEW_JWT_SECRET=$(tr -dc 'A-Za-z0-9+/=' < /dev/urandom | head -c 44)
          NEW_ENCRYPTION_KEY=$(openssl rand -hex 32 2>/dev/null || echo "fallback_key_$(date +%s)")
          
          echo "üîë Generated new secrets"
          
          # Update .env
          if [ "$SECRET_TYPE" = "all" ] || [ "$SECRET_TYPE" = "db_password" ]; then
            sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=$NEW_DB_PASSWORD/" "$ENV_FILE"
            echo "‚úÖ Updated DB_PASSWORD"
          fi
          
          if [ "$SECRET_TYPE" = "all" ]; then
            sed -i "s/JWT_SECRET=.*/JWT_SECRET=$NEW_JWT_SECRET/" "$ENV_FILE"
            sed -i "s/ENCRYPTION_KEY=.*/ENCRYPTION_KEY=$NEW_ENCRYPTION_KEY/" "$ENV_FILE"
            echo "‚úÖ Updated JWT_SECRET and ENCRYPTION_KEY"
            
            # Note: Changing JWT_SECRET will invalidate all existing tokens
            echo "‚ö†Ô∏è  WARNING: JWT_SECRET changed - users will need to re-login"
          fi
          
          # Restart containers
          cd "$COMPOSE_DIR"
          docker-compose restart backend
          sleep 5
          
          # Verify
          if docker-compose ps | grep -q "Up"; then
            echo "‚úÖ Containers restarted successfully"
          else
            echo "‚ùå Containers failed to restart - restoring backup"
            cp "$BACKUP_FILE" "$ENV_FILE"
            docker-compose restart backend
            exit 1
          fi
          
          echo "‚úÖ Secret rotation completed"
          ROTATE_SCRIPT

      - name: Notify success
        if: success()
        run: |
          echo "‚úÖ Secret rotation successful!"
          echo "Environment: ${{ steps.env.outputs.environment }}"
          echo "Type: ${{ github.event.inputs.secret_type || 'db_password' }}"

      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Secret rotation failed!"
          echo "Check the VPS logs and restore from backup if needed"
          exit 1
