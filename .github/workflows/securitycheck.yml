name: ğŸ•µï¸ Security â€¢ Inspector

on:
  workflow_call:
    inputs:
      scan_paths:
        description: "Paths to scan (newline-separated). Example: 'saas/securevault\nbase-infra'"
        required: false
        type: string
        default: "saas/securevault\nbase-infra"
      fail_on_gitleaks:
        description: "Fail the job if gitleaks finds leaks"
        required: false
        type: boolean
        default: true
      upload_sarif:
        description: "Upload Trivy SARIF to GitHub code scanning"
        required: false
        type: boolean
        default: true
      trivy_fail_severity:
        description: "Optional: fail Trivy if vulnerabilities >= this severity (UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL)"
        required: false
        type: string
        default: ""
      publish_score_to_pages:
        description: "Publish security-score.json to GitHub Pages (gh-pages/pages)"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: read
  security-events: write
  pages: write
  id-token: write

jobs:
  security:
    name: ğŸ”­ Security Inspection
    runs-on: ubuntu-latest

    outputs:
      gitleaks_total: ${{ steps.gitleaks.outputs.total }}
      security_score: ${{ steps.score.outputs.score }}
      security_color: ${{ steps.score.outputs.color }}
      security_message: ${{ steps.score.outputs.message }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¾ Resolve scan paths
        run: |
          set -euo pipefail
          echo "## ğŸ” Security Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Scan paths:**" >> "$GITHUB_STEP_SUMMARY"
          echo '${{ inputs.scan_paths }}' | sed 's/^/- /' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

      # -------------------------
      # Trivy filesystem scan
      # -------------------------
      - name: ğŸ›¡ï¸ Trivy (filesystem) â†’ SARIF
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
        continue-on-error: true

      - name: ğŸ“¤ Upload Trivy SARIF (optional)
        if: ${{ inputs.upload_sarif }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy-fs"
        continue-on-error: true

      # -------------------------
      # Gitleaks (CLI) with report
      # -------------------------
      - name: ğŸ” Install gitleaks (pinned)
        run: |
          set -euo pipefail
          GITLEAKS_VERSION="8.21.2"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" \
            | tar -xz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: ğŸ” Run gitleaks (json report)
        id: gitleaks
        run: |
          set -euo pipefail

          # Build --source args from scan_paths (newline-separated)
          SOURCES=()
          while IFS= read -r p; do
            [ -z "$p" ] && continue
            SOURCES+=("--source" "$p")
          done <<< "${{ inputs.scan_paths }}"

          if [ "${#SOURCES[@]}" -eq 0 ]; then
            SOURCES=(--source ".")
          fi

          gitleaks detect \
            "${SOURCES[@]}" \
            --config .gitleaks.toml \
            --redact \
            --report-format json \
            --report-path gitleaks-report.json \
            --verbose || true

          test -f gitleaks-report.json || echo "[]" > gitleaks-report.json

          total="$(jq 'length' gitleaks-report.json)"
          echo "total=${total}" >> "$GITHUB_OUTPUT"

          echo "### ğŸ§¨ Gitleaks" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Total findings:** ${total}" >> "$GITHUB_STEP_SUMMARY"

          if [ "$total" -gt 0 ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Top 20 findings (metadata only):**" >> "$GITHUB_STEP_SUMMARY"
            jq -r '.[] | "- rule=\(.RuleID) file=\(.File):\(.StartLine) commit=\(.Commit|tostring|.[0:8])"' gitleaks-report.json \
              | head -n 20 >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- âœ… No findings." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: ğŸ“ Upload gitleaks report (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 7
          if-no-files-found: error

      - name: ğŸ§® Compute Security Score (from gitleaks total)
        id: score
        run: |
          set -euo pipefail
          leaks="${{ steps.gitleaks.outputs.total }}"
          [ -z "$leaks" ] && leaks="0"

          # Simple scoring model (adjust as you want)
          # 0 leaks -> 10/10, 1-2 -> 8/10, 3-5 -> 6/10, >5 -> 4/10
          if [ "$leaks" -eq 0 ]; then
            score="10/10"; color="brightgreen"
          elif [ "$leaks" -le 2 ]; then
            score="8/10"; color="yellow"
          elif [ "$leaks" -le 5 ]; then
            score="6/10"; color="orange"
          else
            score="4/10"; color="red"
          fi

          message="Score ${score} â€¢ leaks=${leaks}"

          echo "score=$score" >> "$GITHUB_OUTPUT"
          echo "color=$color" >> "$GITHUB_OUTPUT"
          echo "message=$message" >> "$GITHUB_OUTPUT"

          mkdir -p security-badges
          cat > security-badges/security-score.json <<EOF
          {
            "schemaVersion": 1,
            "label": "Security Score",
            "message": "${score} (leaks:${leaks})",
            "color": "${color}"
          }
          EOF

          echo "### ğŸ“Š Security Score" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Security Score:** ${score}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Leaks:** ${leaks}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Badge color:** ${color}" >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸ“ Upload Security Score JSON (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-score
          path: security-badges/security-score.json
          retention-days: 14
          if-no-files-found: error

      - name: ğŸ›‘ Block if leaks found
        if: ${{ inputs.fail_on_gitleaks && steps.gitleaks.outputs.total != '0' }}
        run: |
          set -euo pipefail
          echo "âŒ Gitleaks found ${{ steps.gitleaks.outputs.total }} leaks. Blocking."
          exit 1

  publish-security-score:
    name: ğŸ“¤ Publish Security Score (Pages)
    runs-on: ubuntu-latest
    needs: [security]
    if: ${{ inputs.publish_score_to_pages }}
    permissions:
      pages: write
      id-token: write
      contents: read
    steps:
      - name: ğŸ“¥ Download score artifact
        uses: actions/download-artifact@v4
        with:
          name: security-score
          path: public

      - name: ğŸ“¦ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: ğŸš€ Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
