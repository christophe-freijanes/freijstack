name: ü§ñ PR Title Automation

on:
  pull_request:
    types: [opened, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-title:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Auto-generate PR title
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // Si le titre commence d√©j√† par un type conventionnel, ne rien faire
            const conventionalTypes = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert):/;
            if (conventionalTypes.test(pr.title)) {
              console.log('‚úÖ Le titre suit d√©j√† Conventional Commits');
              return;
            }

            // R√©cup√©rer les fichiers modifi√©s
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // Analyser les fichiers pour d√©terminer le type
            const filePaths = files.map(f => f.filename);
            let type = 'chore';
            let scope = '';

            // D√©terminer le type bas√© sur les fichiers modifi√©s
            if (filePaths.some(f => f.startsWith('docs/'))) {
              type = 'docs';
              scope = 'documentation';
            } else if (filePaths.some(f => f.startsWith('.github/workflows/'))) {
              type = 'ci';
              scope = 'github-actions';
            } else if (filePaths.some(f => f.includes('Dockerfile') || f.includes('docker-compose'))) {
              type = 'build';
              scope = 'docker';
            } else if (filePaths.some(f => f.startsWith('portfolio/'))) {
              type = 'feat';
              scope = 'portfolio';
            } else if (filePaths.some(f => f.startsWith('saas/'))) {
              type = 'feat';
              scope = 'saas';
            } else if (filePaths.some(f => f.endsWith('.md'))) {
              type = 'docs';
            } else if (filePaths.some(f => f.endsWith('.css'))) {
              type = 'style';
              scope = 'ui';
            } else if (filePaths.some(f => f.endsWith('.js'))) {
              type = 'feat';
            }

            // Cr√©er le nouveau titre
            const scopePart = scope ? `(${scope})` : '';
            const newTitle = `${type}${scopePart}: ${pr.title}`;

            // Mettre √† jour le titre de la PR
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              title: newTitle
            });

            // Ajouter un commentaire explicatif
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ü§ñ **Titre de PR automatis√©**\n\n` +
                    `Le titre a √©t√© format√© selon [Conventional Commits](https://www.conventionalcommits.org/):\n\n` +
                    `**Ancien titre**: \`${pr.title}\`\n` +
                    `**Nouveau titre**: \`${newTitle}\`\n\n` +
                    `Types d√©tect√©s:\n` +
                    `- **Type**: \`${type}\`\n` +
                    `${scope ? `- **Scope**: \`${scope}\`\n` : ''}` +
                    `- **Fichiers analys√©s**: ${filePaths.length}\n\n` +
                    `Vous pouvez modifier le titre manuellement si n√©cessaire.`
            });

            console.log(`‚úÖ Titre mis √† jour: ${newTitle}`);
