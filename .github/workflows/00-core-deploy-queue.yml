name: ðŸŽ¯ Deploy Queue (Orchestrator)

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name (portfolio, securevault, registry, etc.)'
        required: true
        type: string
      environment:
        description: 'Target environment (staging or production)'
        required: true
        type: string
      deploy_dir:
        description: 'VPS deployment directory'
        required: true
        type: string
      project_path:
        description: 'Project subdirectory (e.g., saas/portfolio)'
        required: false
        type: string
        default: ''
      docker_compose_file:
        description: 'Docker Compose file to use'
        required: false
        type: string
        default: 'docker-compose.yml'
      run_migrations:
        description: 'Run database migrations after deploy'
        required: false
        type: boolean
        default: false
      custom_script:
        description: 'Custom deployment script (bash)'
        required: false
        type: string
        default: ''
    secrets:
      VPS_SSH_KEY:
        required: true
      VPS_SSH_HOST:
        required: true
      VPS_SSH_USER:
        required: true
      REGISTRY_PASSWORD_STAGING:
        required: false
      REGISTRY_USER_STAGING:
        required: false
      REGISTRY_USER_PROD:
        required: false
      REGISTRY_PASSWORD_PROD:
        required: false

concurrency:
  group: vps-ssh-deploy
  cancel-in-progress: false

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: ðŸš€ Deploy ${{ inputs.app_name }} to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: â±ï¸ Staggered Start (avoid SSH collisions)
        run: |
          set -euo pipefail
          DELAY=$((5 + RANDOM % 16))
          echo "â³ Waiting ${DELAY}s"
          sleep "$DELAY"

      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts || true
          echo "SSH_OPTIONS=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" >> "$GITHUB_ENV"

      - name: ðŸš€ Deploy ${{ inputs.app_name }}
        run: |
          set -euo pipefail

          SSH_TARGET="${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"
          BRANCH="${GITHUB_REF##*/}"

          REMOTE_ENV="APP_NAME='${{ inputs.app_name }}' \
          ENVIRONMENT='${{ inputs.environment }}' \
          DEPLOY_DIR='${{ inputs.deploy_dir }}' \
          PROJECT_PATH='${{ inputs.project_path }}' \
          COMPOSE_FILE='${{ inputs.docker_compose_file }}' \
          GH_REPO='${{ github.repository }}' \
          GH_BRANCH='${BRANCH}' \
          GH_SHA='${{ github.sha }}' \
          REGISTRY_USER_PROD='${{ secrets.REGISTRY_USER_PROD }}' \
          REGISTRY_PASSWORD_PROD='${{ secrets.REGISTRY_PASSWORD_PROD }}' \
          REGISTRY_USER_STAGING='${{ secrets.REGISTRY_USER_STAGING }}' \
          REGISTRY_PASSWORD_STAGING='${{ secrets.REGISTRY_PASSWORD_STAGING }}'"

          ssh $SSH_OPTIONS -i ~/.ssh/deploy_key "$SSH_TARGET" "$REMOTE_ENV" bash <<'DEPLOY_SCRIPT'
          set -euo pipefail

          export DOCKER_CLI_HINTS=false

          : "${APP_NAME:?}"
          : "${ENVIRONMENT:?}"
          : "${DEPLOY_DIR:?}"
          : "${COMPOSE_FILE:?}"
          : "${GH_REPO:?}"
          : "${GH_BRANCH:?}"
          : "${GH_SHA:?}"

          docker compose version >/dev/null 2>&1 || { echo "âŒ Docker Compose not available"; exit 1; }

          echo "ðŸ”’ Volume protection ENABLED"
          echo "âŒ docker compose down -v is FORBIDDEN"

          echo "ðŸš€ Deploying ${APP_NAME} â†’ ${ENVIRONMENT}"
          echo "ðŸ”Ž Git: repo=${GH_REPO} branch=${GH_BRANCH} sha=${GH_SHA}"

          mkdir -p "$DEPLOY_DIR"
          cd "$DEPLOY_DIR"

          if [ -d ".git" ]; then
            git fetch origin --tags
            git reset --hard "origin/${GH_BRANCH}"
            git clean -fd
          else
            git clone -b "${GH_BRANCH}" "https://github.com/${GH_REPO}.git" .
          fi

          if [ -n "${PROJECT_PATH:-}" ]; then
            cd "$PROJECT_PATH"
          fi

          [ -f "$COMPOSE_FILE" ] || { echo "âŒ Compose not found: $COMPOSE_FILE"; exit 1; }

          # ==========================================================
          # Registry: generate .htpasswd safely
          # ==========================================================
          if [ "$APP_NAME" = "registry" ]; then
            echo "ðŸ” Generating .htpasswd"
            if [ "$ENVIRONMENT" = "production" ]; then
              : "${REGISTRY_USER_PROD:?REGISTRY_USER_PROD required}"
              : "${REGISTRY_PASSWORD_PROD:?REGISTRY_PASSWORD_PROD required}"
              USER="$REGISTRY_USER_PROD"
              PASS="$REGISTRY_PASSWORD_PROD"
            else
              : "${REGISTRY_USER_STAGING:?REGISTRY_USER_STAGING required}"
              : "${REGISTRY_PASSWORD_STAGING:?REGISTRY_PASSWORD_STAGING required}"
              USER="$REGISTRY_USER_STAGING"
              PASS="$REGISTRY_PASSWORD_STAGING"
            fi
            docker run --rm httpd:2 htpasswd -Bbn "$USER" "$PASS" > .htpasswd
          fi

          # ==========================================================
          # SPECIAL RULE (Option B): Registry promotion staging -> prod
          # ==========================================================
          if [ "$APP_NAME" = "registry" ] && [ "$ENVIRONMENT" = "production" ]; then
            STAGING_COMPOSE="docker-compose.staging.yml"
            PROD_COMPOSE="$COMPOSE_FILE"

            echo "ðŸ›‘ Registry production deploy: stopping STAGING first (containers only)"
            if [ -f "$STAGING_COMPOSE" ]; then
              docker compose -f "$STAGING_COMPOSE" down --remove-orphans || true
            else
              echo "âš ï¸ $STAGING_COMPOSE not found, attempting container removal fallback"
              docker rm -f registry-staging registry-ui-staging 2>/dev/null || true
            fi

            # Resolve host storage paths from compose config (robust, no hardcoding)
            echo "ðŸ”Ž Resolving staging/prod storage paths from compose..."
            STAGING_BIND="$(docker compose -f "$STAGING_COMPOSE" config 2>/dev/null | awk '/device:\s*\.\//{print $2; exit}' || true)"
            PROD_BIND="$(docker compose -f "$PROD_COMPOSE" config 2>/dev/null | awk '/device:\s*\.\//{print $2; exit}' || true)"

            if [ -z "$STAGING_BIND" ] || [ -z "$PROD_BIND" ]; then
              echo "âŒ Could not resolve storage bind paths from compose."
              echo "   Ensure both compose files use driver_opts.device: ./data-staging and ./data-prod"
              exit 1
            fi

            # Convert relative -> absolute
            STAGING_DIR="$(cd "$(dirname "$STAGING_BIND")" 2>/dev/null && pwd)/$(basename "$STAGING_BIND")"
            PROD_DIR="$(cd "$(dirname "$PROD_BIND")" 2>/dev/null && pwd)/$(basename "$PROD_BIND")"

            echo "ðŸ“¦ Promotion source (staging): $STAGING_DIR"
            echo "ðŸ“¦ Promotion target (prod):    $PROD_DIR"

            mkdir -p "$STAGING_DIR" "$PROD_DIR"

            echo "ðŸ§ª Pre-check: show size"
            du -sh "$STAGING_DIR" 2>/dev/null || true
            du -sh "$PROD_DIR" 2>/dev/null || true

            if ! command -v rsync >/dev/null 2>&1; then
              echo "âŒ rsync is required for promotion but not installed."
              exit 1
            fi

            echo "ðŸšš Promoting images: rsync staging -> prod (preserve permissions, delete removed)"
            rsync -a --delete "$STAGING_DIR"/ "$PROD_DIR"/

            echo "âœ… Promotion done"
            du -sh "$PROD_DIR" 2>/dev/null || true
          fi

          # ==========================================================
          # Deploy (safe volumes)
          # ==========================================================
          if [ "$ENVIRONMENT" = "production" ]; then
            echo "ðŸŸ¢ PRODUCTION DEPLOY (no down)"
            docker compose -f "$COMPOSE_FILE" pull
            docker compose -f "$COMPOSE_FILE" up -d --remove-orphans
          else
            echo "ðŸŸ¡ STAGING DEPLOY (down without -v)"
            docker compose -f "$COMPOSE_FILE" down --remove-orphans || true
            docker compose -f "$COMPOSE_FILE" pull
            docker compose -f "$COMPOSE_FILE" up -d --build --remove-orphans
          fi

          # ==========================================================
          # Registry readiness check (local)
          # ==========================================================
          if [ "$APP_NAME" = "registry" ]; then
            LOCAL_BIND="$(docker compose -f "$COMPOSE_FILE" port registry 5000 2>/dev/null || true)"
            if [ -z "$LOCAL_BIND" ]; then
              echo "âŒ Could not detect published port for registry:5000"
              docker compose -f "$COMPOSE_FILE" ps || true
              docker compose -f "$COMPOSE_FILE" logs --tail=200 registry || true
              exit 1
            fi
            LOCAL_PORT="${LOCAL_BIND##*:}"
            echo "âœ… Local registry published on 127.0.0.1:${LOCAL_PORT}"

            echo "â³ Waiting LOCAL registry (http://127.0.0.1:${LOCAL_PORT}/v2/) expect 200/401"
            LAST_LOCAL=""
            for i in {1..60}; do
              LAST_LOCAL=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:${LOCAL_PORT}/v2/" || true)
              echo "  local attempt ${i}/60 -> HTTP ${LAST_LOCAL}"
              if [ "$LAST_LOCAL" = "200" ] || [ "$LAST_LOCAL" = "401" ]; then
                break
              fi
              sleep 1
            done
            if [ "$LAST_LOCAL" != "200" ] && [ "$LAST_LOCAL" != "401" ]; then
              echo "âŒ Local registry not ready (HTTP ${LAST_LOCAL})"
              docker compose -f "$COMPOSE_FILE" ps || true
              docker compose -f "$COMPOSE_FILE" logs --tail=200 registry || true
              exit 1
            fi
          fi

          echo "ðŸ“Š Containers:"
          docker compose -f "$COMPOSE_FILE" ps || true

          echo "ðŸ“¦ Volumes present:"
          docker volume ls || true

          echo "âœ… Deployment finished safely"
          DEPLOY_SCRIPT

      - name: ðŸ—„ï¸ Run Migrations
        if: inputs.run_migrations
        run: |
          ssh $SSH_OPTIONS -i ~/.ssh/deploy_key \
            ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            "cd ${{ inputs.deploy_dir }}/${{ inputs.project_path }} && docker compose exec -T app npm run migrate || true"

      - name: âœ… Deployment Summary
        if: success()
        run: |
          echo "## âœ… Deployment Successful" >> "$GITHUB_STEP_SUMMARY"
          echo "- App: ${{ inputs.app_name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Env: ${{ inputs.environment }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commit: ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_STEP_SUMMARY"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> "$GITHUB_STEP_SUMMARY"
          echo "- App: ${{ inputs.app_name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Env: ${{ inputs.environment }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commit: ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Attempted at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_STEP_SUMMARY"
