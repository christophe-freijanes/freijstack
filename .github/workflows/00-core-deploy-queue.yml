name: ðŸŽ¯ Deploy Queue (Orchestrator)

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name (portfolio, securevault, registry, etc.)'
        required: true
        type: string
      environment:
        description: 'Target environment (staging or production)'
        required: true
        type: string
      deploy_dir:
        description: 'VPS deployment directory'
        required: true
        type: string
      project_path:
        description: 'Project subdirectory (e.g., saas/portfolio)'
        required: false
        type: string
        default: ''
      docker_compose_file:
        description: 'Docker Compose file to use'
        required: false
        type: string
        default: 'docker-compose.yml'
      run_migrations:
        description: 'Run database migrations after deploy'
        required: false
        type: boolean
        default: false
      custom_script:
        description: 'Custom deployment script (bash)'
        required: false
        type: string
        default: ''
    secrets:
      VPS_SSH_KEY:
        required: true
      VPS_SSH_HOST:
        required: true
      VPS_SSH_USER:
        required: true
      REGISTRY_PASSWORD_STAGING:
        required: false
      REGISTRY_USER_STAGING:
        required: false
      REGISTRY_USER_PROD:
        required: false
      REGISTRY_PASSWORD_PROD:
        required: false

concurrency:
  group: vps-ssh-deploy
  cancel-in-progress: false

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: ðŸš€ Deploy ${{ inputs.app_name }} to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: â±ï¸ Staggered Start
        run: |
          DELAY=$((5 + RANDOM % 16))
          sleep $DELAY

      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts || true
          echo "SSH_OPTIONS=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" >> $GITHUB_ENV

      - name: ðŸš€ Deploy ${{ inputs.app_name }}
        run: |
          set -euo pipefail
          SSH_TARGET="${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"

          ssh $SSH_OPTIONS -i ~/.ssh/deploy_key "$SSH_TARGET" bash <<'DEPLOY'
          set -euo pipefail

          APP_NAME="${{ inputs.app_name }}"
          ENVIRONMENT="${{ inputs.environment }}"
          DEPLOY_DIR="${{ inputs.deploy_dir }}"
          PROJECT_PATH="${{ inputs.project_path }}"
          COMPOSE_FILE="${{ inputs.docker_compose_file }}"

          REGISTRY_USER_PROD="${{ secrets.REGISTRY_USER_PROD }}"
          REGISTRY_PASSWORD_PROD="${{ secrets.REGISTRY_PASSWORD_PROD }}"
          REGISTRY_USER_STAGING="${{ secrets.REGISTRY_USER_STAGING }}"
          REGISTRY_PASSWORD_STAGING="${{ secrets.REGISTRY_PASSWORD_STAGING }}"

          echo "ðŸš€ Deploy $APP_NAME ($ENVIRONMENT)"

          mkdir -p "$DEPLOY_DIR"
          cd "$DEPLOY_DIR"

          if [ -d ".git" ]; then
            git fetch origin
            git reset --hard origin/${GITHUB_REF##*/}
            git clean -fd
          else
            git clone -b "${GITHUB_REF##*/}" "https://github.com/${GITHUB_REPOSITORY}.git" .
          fi

          [ -n "$PROJECT_PATH" ] && cd "$PROJECT_PATH"

          if [ "$APP_NAME" = "registry" ]; then
            echo "ðŸ” Generating .htpasswd"
            if [ "$ENVIRONMENT" = "production" ]; then
              USER="$REGISTRY_USER_PROD"
              PASS="$REGISTRY_PASSWORD_PROD"
            else
              USER="$REGISTRY_USER_STAGING"
              PASS="$REGISTRY_PASSWORD_STAGING"
            fi

            docker run --rm httpd:2 \
              htpasswd -Bbn "$USER" "$PASS" > .htpasswd
          fi

          if [ "$ENVIRONMENT" = "production" ]; then
            echo "â³ Waiting registry public endpoint"
            for i in {1..60}; do
              CODE=$(curl -s -o /dev/null -w "%{http_code}" https://registry.freijstack.com/v2/ || true)
              [ "$CODE" = "200" ] || [ "$CODE" = "401" ] && break
              sleep 1
            done

            if [ -n "$REGISTRY_USER_PROD" ]; then
              echo "$REGISTRY_PASSWORD_PROD" | docker login registry.freijstack.com \
                -u "$REGISTRY_USER_PROD" --password-stdin
            fi

            docker compose -f "$COMPOSE_FILE" pull
            docker compose -f "$COMPOSE_FILE" up -d --remove-orphans
          else
            docker compose -f "$COMPOSE_FILE" down --remove-orphans || true
            docker compose -f "$COMPOSE_FILE" pull
            docker compose -f "$COMPOSE_FILE" up -d --build --remove-orphans
          fi

          docker compose -f "$COMPOSE_FILE" ps
          DEPLOY

      - name: ðŸ—„ï¸ Run Migrations
        if: inputs.run_migrations
        run: |
          ssh $SSH_OPTIONS -i ~/.ssh/deploy_key \
          ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
          "cd ${{ inputs.deploy_dir }}/${{ inputs.project_path }} && docker compose exec -T app npm run migrate || true"

      - name: âœ… Deployment Summary
        if: success()
        run: |
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "- App: ${{ inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Env: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
