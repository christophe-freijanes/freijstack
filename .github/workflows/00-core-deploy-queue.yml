name: üéØ Deploy Queue (Orchestrator)

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name (portfolio, securevault, registry, etc.)'
        required: true
        type: string
      environment:
        description: 'Target environment (staging or production)'
        required: true
        type: string
      deploy_dir:
        description: 'VPS deployment directory'
        required: true
        type: string
      project_path:
        description: 'Project subdirectory (e.g., saas/portfolio)'
        required: false
        type: string
        default: ''
      docker_compose_file:
        description: 'Docker Compose file to use'
        required: false
        type: string
        default: 'docker-compose.yml'
      run_migrations:
        description: 'Run database migrations after deploy'
        required: false
        type: boolean
        default: false
      custom_script:
        description: 'Custom deployment script (bash)'
        required: false
        type: string
        default: ''
    secrets:
      VPS_SSH_KEY:
        required: true
      VPS_SSH_HOST:
        required: true
      VPS_SSH_USER:
        required: true

# Global concurrency: only one deployment at a time across ALL apps
concurrency:
  group: vps-ssh-deploy
  cancel-in-progress: false

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: üöÄ Deploy ${{ inputs.app_name }} to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: ‚è±Ô∏è Staggered Start (avoid SSH collisions)
        run: |
          # Random delay between 5-20s to stagger parallel deployments
          DELAY=$((5 + RANDOM % 16))
          echo "üïí Waiting ${DELAY}s to avoid SSH collision..."
          sleep $DELAY

      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Setup SSH
        run: |
          set -euo pipefail

          # Validate secrets
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ùå VPS_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_HOST }}" ]; then
            echo "‚ùå VPS_SSH_HOST secret is not set"
            exit 1
          fi

          # Setup SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Scan SSH host keys with retry (5 attempts); if all fail, proceed with relaxed host-key checking
          SSH_SCAN_FAILED=1
          echo "üîç Scanning SSH host keys for ${{ secrets.VPS_SSH_HOST }}..."
          for i in {1..5}; do
            if ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts 2>/tmp/ssh-scan-err; then
              echo "‚úÖ SSH host keys retrieved (attempt $i/5)"
              SSH_SCAN_FAILED=0
              break
            else
              echo "‚ö†Ô∏è Attempt $i/5 failed:"
              cat /tmp/ssh-scan-err || true
              sleep 3
            fi
          done

          SSH_OPTIONS="-o StrictHostKeyChecking=yes"
          if [ $SSH_SCAN_FAILED -eq 1 ]; then
            echo "‚ö†Ô∏è Proceeding without host key verification (scan failed after 5 attempts)"
            echo "   Check: VPS firewall, SSH port 22, VPS_SSH_HOST secret"
            SSH_OPTIONS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          fi

      - name: üîí Mask sensitive values
        run: |
          echo "::add-mask::${{ secrets.VPS_SSH_USER }}"
          echo "::add-mask::${{ secrets.VPS_SSH_HOST }}"

      - name: üöÄ Deploy ${{ inputs.app_name }}
        run: |
          set -euo pipefail

          echo "üì¶ Deploying ${{ inputs.app_name }} to ${{ inputs.environment }}..."
          echo "üìÇ Deploy directory: ${{ inputs.deploy_dir }}"

          SSH_TARGET="${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"

          # Export variables for remote script
          REMOTE_ENV="APP_NAME='${{ inputs.app_name }}' \
          ENVIRONMENT='${{ inputs.environment }}' \
          DEPLOY_DIR='${{ inputs.deploy_dir }}' \
          PROJECT_PATH='${{ inputs.project_path }}' \
          COMPOSE_FILE='${{ inputs.docker_compose_file }}' \
          GITHUB_REPO='${{ github.repository }}' \
          GITHUB_REF='${{ github.ref }}'"

          if [ -n "${{ inputs.custom_script }}" ]; then
            # Use custom deployment script if provided
            echo "üîß Using custom deployment script..."
            echo "${{ inputs.custom_script }}" | ssh ${SSH_OPTIONS} -i ~/.ssh/deploy_key "${SSH_TARGET}" "${REMOTE_ENV}" bash
          else
            # Generic deployment script
            ssh ${SSH_OPTIONS} -i ~/.ssh/deploy_key "${SSH_TARGET}" "${REMOTE_ENV}" bash <<'DEPLOY_SCRIPT'
            set -e
            echo "üöÄ Starting deployment for $APP_NAME ($ENVIRONMENT)..."

            # Create deploy directory
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            # Clone or update repository
            if [ -d ".git" ]; then
              echo "‚úÖ Repository exists, pulling latest changes..."
              git fetch origin
              git reset --hard "origin/${GITHUB_REF##*/}"
              git clean -fd
            else
              # Clean directory if it exists but is not a git repo
              if [ "$(ls -A .)" ]; then
                echo "‚ö†Ô∏è Directory exists but is not a git repository, cleaning..."
                rm -rf ..?* .[!.]* *
              fi
              echo "üì• Cloning repository..."
              BRANCH="${GITHUB_REF##*/}"
              git clone -b "${BRANCH}" "https://github.com/${GITHUB_REPO}.git" .
            fi

            # Navigate to project subdirectory if specified
            if [ -n "$PROJECT_PATH" ]; then
              echo "üìÇ Entering project directory: $PROJECT_PATH"
              cd "$PROJECT_PATH"
            fi

            # Use per-app/per-env project name to avoid reusing stale volumes
            export COMPOSE_PROJECT_NAME="${APP_NAME}-${ENVIRONMENT}"

            # Deploy with Docker Compose
            echo "üê≥ Deploying with $COMPOSE_FILE..."
            if [ -f "$COMPOSE_FILE" ]; then
              echo "üõë Stopping previous stack (if any) to avoid name/volume conflicts..."
              docker compose -f "$COMPOSE_FILE" down --remove-orphans || true

              docker compose -f "$COMPOSE_FILE" pull
              docker compose -f "$COMPOSE_FILE" up -d --build --remove-orphans

              echo "‚è≥ Waiting 10s for services to start..."
              sleep 10

              echo "üìä Container status:"
              docker compose -f "$COMPOSE_FILE" ps

              echo "üìú Recent logs:"
              docker compose -f "$COMPOSE_FILE" logs --tail=20
            else
              echo "‚ùå Docker Compose file not found: $COMPOSE_FILE"
              exit 1
            fi

            echo "‚úÖ Deployment completed for $APP_NAME!"
          DEPLOY_SCRIPT
          fi

      - name: üóÑÔ∏è Run Migrations
        if: inputs.run_migrations
        run: |
          echo "üóÑÔ∏è Running database migrations..."
          ssh ${SSH_OPTIONS} -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            "cd ${{ inputs.deploy_dir }}/${{ inputs.project_path }} && \
            docker compose exec -T backend npm run migrate 2>/dev/null || \
            docker compose exec -T app npm run migrate 2>/dev/null || \
            echo '‚ö†Ô∏è No migration script found or failed'"

      - name: ‚úÖ Deployment Summary
        if: success()
        run: |
          echo "## ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: ${{ inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Directory**: \`${{ inputs.deploy_dir }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Compose File**: \`${{ inputs.docker_compose_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Migrations**: ${{ inputs.run_migrations && '‚úÖ Executed' || '‚è≠Ô∏è Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéØ Deployed by: \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "üìù Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Deployment Failed
        if: failure()
        run: |
          echo "## ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: ${{ inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check logs above for details." >> $GITHUB_STEP_SUMMARY
          exit 1
