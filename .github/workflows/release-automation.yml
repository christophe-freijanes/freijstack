name: ğŸš€ Release Automation â€¢ Semantic Versioning

on:
  workflow_run:
    workflows: ["ğŸ¥ Production Health Check"]
    types: [completed]
    # âš ï¸ Ce filtre "branches" ne suffit pas toujours selon le contexte d'exÃ©cution.
    # On re-filtre aussi via head_branch dans le precheck (plus fiable).
    branches: [master]

permissions:
  contents: write
  actions: read
  pull-requests: read

concurrency:
  group: release-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  precheck:
    name: ğŸ§­ Precheck â€¢ Should we release?
    runs-on: ubuntu-latest

    outputs:
      should_release: ${{ steps.decide.outputs.should_release }}
      reason: ${{ steps.decide.outputs.reason }}

    steps:
      - name: ğŸ§¾ Decide release eligibility
        id: decide
        run: |
          set -euo pipefail

          conclusion="${{ github.event.workflow_run.conclusion }}"
          event="${{ github.event.workflow_run.event }}"
          head_branch="${{ github.event.workflow_run.head_branch }}"
          msg="${{ github.event.workflow_run.head_commit.message }}"

          should="false"
          reason=""

          if [ "$conclusion" != "success" ]; then
            reason="Health Check conclusion is '$conclusion' (expected 'success')."
          elif [ "$event" != "push" ]; then
            reason="Health Check was triggered by '$event' (release runs only on push)."
          elif [ "$head_branch" != "master" ]; then
            reason="Health Check head_branch is '$head_branch' (expected 'master')."
          elif echo "$msg" | grep -q "\[skip ci\]"; then
            reason="Head commit message contains [skip ci]."
          else
            should="true"
            reason="All conditions satisfied (success + push + master + no [skip ci])."
          fi

          echo "should_release=$should" >> "$GITHUB_OUTPUT"
          echo "reason=$reason" >> "$GITHUB_OUTPUT"

          echo "## ğŸ§­ Release precheck" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- HealthCheck run: ${{ github.event.workflow_run.html_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- event: **$event**" >> "$GITHUB_STEP_SUMMARY"
          echo "- head_branch: **$head_branch**" >> "$GITHUB_STEP_SUMMARY"
          echo "- conclusion: **$conclusion**" >> "$GITHUB_STEP_SUMMARY"
          echo "- head_sha: \`${{ github.event.workflow_run.head_sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "$should" = "true" ]; then
            echo "âœ… **Release allowed**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "â­ï¸ **Release skipped**" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Reason:** $reason" >> "$GITHUB_STEP_SUMMARY"

  release:
    name: ğŸ·ï¸ Secure Release Pipeline
    needs: precheck
    if: ${{ needs.precheck.outputs.should_release == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository (same commit as Health Check)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      # ---------------------------
      # ğŸš¦ SECURITY GATE â€” GITLEAKS REPORT
      # ---------------------------
      - name: ğŸš¦ Security gate â€” fetch gitleaks report from Health Check run
        id: gate
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "ğŸ” Looking for artifact 'gitleaks-report' in run ${RUN_ID}..."

          artifacts_json=$(gh api -H "Accept: application/vnd.github+json" "/repos/${REPO}/actions/runs/${RUN_ID}/artifacts")
          artifact_id=$(echo "$artifacts_json" | jq -r '.artifacts[] | select(.name=="gitleaks-report") | .id' | head -n 1)

          if [ -z "${artifact_id}" ] || [ "${artifact_id}" = "null" ]; then
            echo "report_present=false" >> "$GITHUB_OUTPUT"
            echo "total=0" >> "$GITHUB_OUTPUT"

            echo "## ğŸ” Security Gate" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "â„¹ï¸ No gitleaks-report artifact found for this run. Continuing." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "âœ… Found artifact id: ${artifact_id}"
          mkdir -p security
          gh api -H "Accept: application/vnd.github+json" \
            "/repos/${REPO}/actions/artifacts/${artifact_id}/zip" > security/artifact.zip

          unzip -o security/artifact.zip -d security

          if [ ! -f security/gitleaks-report.json ]; then
            echo "report_present=false" >> "$GITHUB_OUTPUT"
            echo "total=0" >> "$GITHUB_OUTPUT"

            echo "## ğŸ” Security Gate" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "âš ï¸ Artifact found but gitleaks-report.json missing. Continuing." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "report_present=true" >> "$GITHUB_OUTPUT"
          total="$(jq 'length' security/gitleaks-report.json)"
          echo "total=${total}" >> "$GITHUB_OUTPUT"
          echo "ğŸ”¢ total_findings=${total}"

      - name: âœ… Security gate passed
        if: ${{ steps.gate.outputs.report_present == 'true' && steps.gate.outputs.total == '0' }}
        run: |
          echo "## ğŸ” Security Gate" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… No gitleaks findings detected. Release allowed." >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸ›‘ Stop release (gitleaks findings detected) + diagnostics
        if: ${{ steps.gate.outputs.report_present == 'true' && steps.gate.outputs.total != '0' }}
        run: |
          set -euo pipefail

          REPORT="security/gitleaks-report.json"
          TOTAL="${{ steps.gate.outputs.total }}"

          echo "ğŸš¨ Gitleaks findings detected. Blocking release."
          echo "ğŸ”¢ Total findings: $TOTAL"

          echo "## ğŸš¨ Gitleaks â€“ Release blocked" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Total findings:** $TOTAL" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Health Check run:** ${{ github.event.workflow_run.html_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit:** \`${{ github.event.workflow_run.head_sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### ğŸ“ Findings (metadata only)" >> "$GITHUB_STEP_SUMMARY"
          jq -r '.[] | "- rule=\(.RuleID) file=\(.File):\(.StartLine) commit=\(.Commit|tostring|.[0:8])"' "$REPORT" \
            | head -n 20 >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "> â„¹ï¸ Values are redacted. Full report is attached to the Health Check run as an artifact." >> "$GITHUB_STEP_SUMMARY"

          exit 1

      # ---------------------------
      # ğŸ“¦ NODE + DEPENDENCY AUDIT
      # ---------------------------
      - name: ğŸ§¾ Detect JS lockfile
        id: lock
        run: |
          set -euo pipefail
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ] || [ -f yarn.lock ]; then
            echo "has_lock=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_lock=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸŸ¢ Setup Node.js (LTS) â€” with cache
        if: ${{ steps.lock.outputs.has_lock == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            package-lock.json
            npm-shrinkwrap.json
            yarn.lock

      - name: ğŸŸ¢ Setup Node.js (LTS) â€” no cache
        if: ${{ steps.lock.outputs.has_lock != 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ğŸ“¦ Install dependencies (npm ci)
        if: ${{ steps.lock.outputs.has_lock == 'true' }}
        run: |
          set -euo pipefail
          npm ci

      - name: ğŸ” Dependency vulnerability scan (high+)
        if: ${{ steps.lock.outputs.has_lock == 'true' }}
        run: |
          set -euo pipefail
          npm audit --audit-level=high

      # ---------------------------
      # ğŸš€ SEMANTIC-RELEASE
      # ---------------------------
      - name: ğŸ“¦ Install semantic-release tooling
        run: |
          set -euo pipefail
          npm install -D \
            semantic-release \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            @semantic-release/github \
            @semantic-release/changelog

      - name: ğŸ§­ Debug GitHub auth + repo
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          set -euo pipefail
          echo "ref_name: $GITHUB_REF_NAME"
          git remote -v
          gh api /repos/${{ github.repository }} --jq '{full_name: .full_name, private: .private, permissions: .permissions}'

      - name: ğŸ·ï¸ Create tag & GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          set -euo pipefail
          npx semantic-release

      - name: ğŸ‰ Pipeline completed
        run: echo "âœ… Secure release successfully published!"
