name: ðŸ•µï¸ Security Triage â€¢ Gitleaks

on:
  workflow_run:
    workflows: ["ðŸ¥ Production Health Check"]
    types: [completed]
    branches: [master]

permissions:
  actions: read
  contents: read

jobs:
  triage:
    name: ðŸ§¯ Triage gitleaks findings
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”Ž Locate gitleaks artifact on source run
        id: locate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "ðŸ”Ž Looking for artifact 'gitleaks-report' in run ${RUN_ID}..."

          # Liste des artefacts du run source
          artifacts_json=$(gh api -H "Accept: application/vnd.github+json" "/repos/${REPO}/actions/runs/${RUN_ID}/artifacts")

          # RÃ©cupÃ¨re l'ID de l'artefact nommÃ© "gitleaks-report"
          artifact_id=$(echo "$artifacts_json" | jq -r '.artifacts[] | select(.name=="gitleaks-report") | .id' | head -n 1)

          if [ -z "${artifact_id}" ] || [ "${artifact_id}" = "null" ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "âœ… No gitleaks-report artifact found (no findings or upload skipped)."
            exit 0
          fi

          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "artifact_id=${artifact_id}" >> "$GITHUB_OUTPUT"
          echo "âœ… Found artifact id: ${artifact_id}"

      - name: ðŸ“¥ Download gitleaks artifact (zip) + extract
        if: ${{ steps.locate.outputs.found == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ARTIFACT_ID: ${{ steps.locate.outputs.artifact_id }}
        run: |
          set -euo pipefail
          mkdir -p triage

          echo "â¬‡ï¸ Downloading artifact ${ARTIFACT_ID}..."
          gh api -H "Accept: application/vnd.github+json" \
            "/repos/${REPO}/actions/artifacts/${ARTIFACT_ID}/zip" > triage/artifact.zip

          unzip -o triage/artifact.zip -d triage
          echo "ðŸ“¦ Extracted files:"
          ls -la triage

      - name: âœ… No artifact â€” nothing to triage
        if: ${{ steps.locate.outputs.found != 'true' }}
        run: |
          echo "âœ… No gitleaks artifact for run ${{ github.event.workflow_run.id }}. Nothing to triage."
          exit 0

      - name: ðŸ§¾ Summarize findings (metadata only)
        if: ${{ steps.locate.outputs.found == 'true' }}
        run: |
          set -euo pipefail

          REPORT="triage/gitleaks-report.json"
          if [ ! -f "$REPORT" ]; then
            echo "âŒ Expected $REPORT not found after artifact extraction."
            exit 1
          fi

          total="$(jq 'length' "$REPORT")"
          echo "## ðŸ” Gitleaks findings (metadata only)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Source run: ${{ github.event.workflow_run.html_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commit: \`${{ github.event.workflow_run.head_sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Total findings: **${total}**" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "$total" -eq 0 ]; then
            echo "âœ… No findings." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "### ðŸ“ Findings (top 50)" >> "$GITHUB_STEP_SUMMARY"
          jq -r '.[] | "- rule=\(.RuleID) file=\(.File):\(.StartLine) commit=\(.Commit|tostring|.[0:8])"' "$REPORT" \
            | head -n 50 >> "$GITHUB_STEP_SUMMARY"
