name: ğŸ“„ SaaS â€¢ Portfolio

on:
  push:
    branches:
      - master
      - develop
    paths:
      - 'saas/portfolio/**'
      - '.github/workflows/portfolio-deploy.yml'
      - 'package.json'

  pull_request:
    branches:
      - master
      - develop
    paths:
      - 'saas/portfolio/**'
      - '.github/workflows/portfolio-deploy.yml'
      - 'package.json'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  IS_PRODUCTION: ${{ github.ref == 'refs/heads/master' }}
  IS_STAGING: ${{ github.ref == 'refs/heads/develop' }}

jobs:
  # Job 1: Security Scanning
  security:
    name: ğŸ›¡ï¸ Shield Protection
    uses: ./.github/workflows/securitycheck.yml
    permissions:
      contents: read
      actions: read
      security-events: write
    with:
      scan_paths: |
        saas/portfolio
        base-infra
      fail_on_gitleaks: true
      upload_sarif: true
      publish_score_artifact: true

  # Job 2: Validation et Linting
  validate:
    name: âœ… Validate & Lint
    runs-on: ubuntu-latest
    needs: security
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Lint HTML
        run: |
          npm install -g html-validate
          html-validate saas/portfolio/index.html || true
      - name: Validate CSS
        run: |
          npm install -g stylelint stylelint-config-standard
          stylelint "saas/portfolio/style.css" || true
      - name: Check JavaScript
        run: |
          npm install -g eslint
          eslint saas/portfolio/script.js || true
      - name: Security audit
        run: npm audit --audit-level=moderate || true

  # Job 3: Build & Optimize Assets
  build:
    name: ğŸ—ï¸ Build & Optimize
    runs-on: ubuntu-latest
    needs: [security, validate]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Minify CSS
        run: |
          npm install -g csso-cli
          csso saas/portfolio/style.css -o saas/portfolio/style.min.css
          echo "âœ… CSS minified"
      - name: Minify JavaScript
        run: |
          npm install -g terser
          terser saas/portfolio/script.js -o saas/portfolio/script.min.js -c -m
          echo "âœ… JavaScript minified"
      - name: Optimize assets
        run: |
          echo "Asset sizes before optimization:"
          ls -lh saas/portfolio/*.{css,js} | awk '{print $9, $5}'
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: saas/portfolio/
          retention-days: 5

  # Job 4: Deploy to GitHub Pages
  deploy-pages:
    name: ğŸ“„ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [security, validate, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        continue-on-error: true
        uses: actions/configure-pages@v4

      - name: Build static site
        run: |
          mkdir -p _site
          cp -r saas/portfolio/* _site/
          echo "<!-- STAGING ENVIRONMENT -->" >> _site/index.html
          echo "âœ… Staging site built"

      - name: ğŸ“¥ Download Security Score artifact
        uses: actions/download-artifact@v4
        with:
          name: security-score
          path: _score
        continue-on-error: true

      - name: ğŸ§© Inject security-score.json into site root
        run: |
          set -euo pipefail
          if [ -f "_score/security-score.json" ]; then
            cp "_score/security-score.json" "_site/security-score.json"
            echo "âœ… Injected _site/security-score.json"
          else
            echo "âš ï¸ No security-score.json artifact found; skipping"
          fi

      - name: Upload artifact
        continue-on-error: true
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        continue-on-error: true
        uses: actions/deploy-pages@v4

  # Job 5: Deploy to VPS (Staging - develop)
  # Note: Ce workflow copie les fichiers statiques via rsync.
  # TODO: Migrer vers docker-compose up depuis portfolio/docker-compose.yml
  deploy-VPS-staging:
    name: ğŸ§ª Deploy to VPS (Staging)
    runs-on: ubuntu-latest
    needs: [security, validate, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_SSH_HOST }} >> ~/.ssh/known_hosts
      - name: Create staging directory on VPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'mkdir -p /srv/www/portfolio-staging && echo "ğŸ“ Staging directory ready"'
      - name: Backup existing staging (if exists)
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'if [ -d /srv/www/portfolio-staging ] && [ "$(ls -A /srv/www/portfolio-staging)" ]; then \
               cp -r /srv/www/portfolio-staging /srv/www/portfolio-staging.backup.$(date +%s); \
               echo "ğŸ’¾ Backup created"; \
             fi'
      - name: Deploy portfolio to staging (/portfolio-staging)
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
            saas/portfolio/ ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}:/srv/www/portfolio-staging/
      - name: Verify staging deployment
        run: |
          echo "âœ… Portfolio dÃ©ployÃ© vers STAGING!"
          echo "ğŸ“ Path: /srv/www/portfolio-staging"
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'ls -lh /srv/www/portfolio-staging/ | head -10'
      - name: Cleanup old staging backups (keep last 3)
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'ls -dt /srv/www/portfolio-staging.backup.* 2>/dev/null | tail -n +4 | xargs -r rm -rf || true'
      - name: Restart Traefik on VPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'C=$(docker ps --filter "name=traefik" --format "{{.Names}}" | head -n1); if [ -n "$C" ]; then docker restart "$C"; fi'
  # Job 6: Deploy to VPS (Production - master)
  # Note: Ce workflow copie les fichiers statiques via rsync.
  # TODO: Migrer vers docker-compose up depuis portfolio/docker-compose.yml
  deploy-VPS:
    name: ğŸš€ Deploy to VPS (Production)
    runs-on: ubuntu-latest
    needs: [security, validate, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_SSH_HOST }} >> ~/.ssh/known_hosts
      - name: Create production directory on VPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'mkdir -p /srv/www/portfolio && echo "ğŸ“ Production directory ready"'
      - name: Backup existing production (if exists)
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'if [ -d /srv/www/portfolio ] && [ "$(ls -A /srv/www/portfolio)" ]; then \
               cp -r /srv/www/portfolio /srv/www/portfolio.backup.$(date +%s); \
               echo "ğŸ’¾ Backup created"; \
             fi'
      - name: Deploy portfolio to production (/portfolio)
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
            saas/portfolio/ ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}:/srv/www/portfolio/
      - name: Verify production deployment
        run: |
          echo "âœ… Portfolio dÃ©ployÃ© vers PRODUCTION!"
          echo "ğŸ“ Production: https://${{ secrets.VPS_DOMAIN }}/portfolio/"
          echo "ğŸ“ GitHub Pages: https://${{ github.repository_owner }}.github.io/freijstack/portfolio"
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'ls -lh /srv/www/portfolio/ | head -10'
      - name: Cleanup old production backups (keep last 3)
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'ls -dt /srv/www/portfolio.backup.* 2>/dev/null | tail -n +4 | xargs -r rm -rf || true'
      - name: Restart Traefik on VPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'C=$(docker ps --filter "name=traefik" --format "{{.Names}}" | head -n1); if [ -n "$C" ]; then docker restart "$C"; fi'
  # Job 7: Notifications
  notify:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [security, validate, build]
    if: always()
    
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ” Pull Request - Validation Only"
            echo "âœ… Code validation and security checks completed"
            echo "ğŸ“‹ No deployment on pull requests"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "ğŸ§ª STAGING Environment - Push Event"
            echo "âœ… Staging deployment triggered"
            echo "ğŸ“ Test your changes before merging to master"
          elif [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "ğŸš€ PRODUCTION Environment - Push Event"
            echo "âœ… Production deployment triggered"
            echo "ğŸ¯ Portfolio is live on VPS"
          else
            echo "â„¹ï¸ Event: ${{ github.event_name }} on ${{ github.ref }}"
          fi
      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## FreijStack Release
            Portfolio deployment completed successfully!
            - Portfolio: Live on GitHub Pages & VPS
            - Security: All checks passed
            - Performance: Assets optimized
          draft: false
          prerelease: false