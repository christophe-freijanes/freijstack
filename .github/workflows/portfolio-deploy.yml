name: üìÑ SaaS ‚Ä¢ Portfolio Deploy

on:
  workflow_run:
    workflows: ["üèóÔ∏è Build & Push Portfolio"]
    types: [completed]
    branches: [master, develop]

  pull_request:
    branches: [master, develop]
    paths:
      - 'saas/portfolio/**'
      - '.github/workflows/portfolio-deploy.yml'

env:
  REGISTRY: registry.freijstack.com
  IMAGE_NAME: portfolio

jobs:
  # Job 1: Deploy to VPS (Staging - develop)
  deploy-VPS-staging:
    name: üß™ Deploy to VPS (Staging)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.head_branch == 'develop' &&
       github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD_PROD }}" | \
          docker login -u "${{ secrets.REGISTRY_USERNAME_PROD }}" \
          --password-stdin ${{ env.REGISTRY }}

      - name: Verify Docker image integrity
        run: |
          echo "üîê Verifying Docker image integrity..."
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-beta"
          docker run --rm --entrypoint sh $IMAGE -c 'echo "‚úÖ Image validation successful"' || exit 1

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy portfolio (Docker Compose) to staging
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'cd /srv/www/saas/portfolio && \
             docker compose -f docker-compose.yml pull && \
             docker compose -f docker-compose.yml down || true && \
             docker compose -f docker-compose.yml up -d && \
             echo "‚úÖ Portfolio staging deployed successfully" && \
             docker compose -f docker-compose.yml logs --tail=5'

      - name: Verify staging deployment
        run: |
          set -euo pipefail
          sleep 5
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://portfolio-staging.freijstack.com/ || echo "000")
          if [ "$HEALTH" = "200" ] || [ "$HEALTH" = "301" ] || [ "$HEALTH" = "302" ]; then
            echo "‚úÖ Staging health check passed (HTTP $HEALTH)"
          else
            echo "‚ö†Ô∏è Staging health check returned HTTP $HEALTH"
          fi

  # Job 2: Deploy to VPS (Production - master)
  deploy-VPS-prod:
    name: üöÄ Deploy to VPS (Production)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.head_branch == 'master' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD_PROD }}" | \
          docker login -u "${{ secrets.REGISTRY_USERNAME_PROD }}" \
          --password-stdin ${{ env.REGISTRY }}

      - name: Verify Docker image integrity
        run: |
          echo "üîê Verifying Docker image integrity..."
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          docker run --rm --entrypoint sh $IMAGE -c 'echo "‚úÖ Image validation successful"' || exit 1

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create production backup
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'cd /srv/www/saas/portfolio && \
             docker compose -f docker-compose.prod.yml ps || true && \
             echo "üíæ Backup timestamp: $(date +%s)" || true'

      - name: Deploy portfolio (Docker Compose) to production
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            'cd /srv/www/saas/portfolio && \
             docker compose -f docker-compose.prod.yml pull && \
             docker compose -f docker-compose.prod.yml down || true && \
             docker compose -f docker-compose.prod.yml up -d && \
             echo "‚úÖ Portfolio production deployed successfully" && \
             docker compose -f docker-compose.prod.yml logs --tail=5'

      - name: Verify production deployment
        run: |
          set -euo pipefail
          sleep 5
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" https://portfolio.freijstack.com/ || echo "000")
          if [ "$HEALTH" = "200" ] || [ "$HEALTH" = "301" ] || [ "$HEALTH" = "302" ]; then
            echo "‚úÖ Production health check passed (HTTP $HEALTH)"
          else
            echo "‚ö†Ô∏è Production health check returned HTTP $HEALTH"
          fi

  # Job 3: Notifications
  notify:
    name: üì¢ Notify Status
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Check deployment status
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "üîç Pull Request - Validation Only"
            echo "‚úÖ Portfolio deployment template validated"
            echo "üìã No deployment on pull requests"
          elif [ "${{ github.event_name }}" == "workflow_run" ] && [ "${{ github.event.workflow_run.head_branch }}" == "develop" ]; then
            echo "üß™ STAGING Environment - Docker Deployment"
            echo "‚úÖ Portfolio image deployed to staging"
            echo "üìç URL: https://portfolio-staging.freijstack.com"
          elif [ "${{ github.event_name }}" == "workflow_run" ] && [ "${{ github.event.workflow_run.head_branch }}" == "master" ]; then
            echo "üöÄ PRODUCTION Environment - Docker Deployment"
            echo "‚úÖ Portfolio image deployed to production"
            echo "üéØ URL: https://portfolio.freijstack.com"
          else
            echo "‚ÑπÔ∏è Event: ${{ github.event_name }}"
          fi
