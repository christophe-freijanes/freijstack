name: üßπ Registry Cleanup ‚Ä¢ Old Images

on:
  schedule:
    - cron: "0 2 * * 0"  # Every Sunday at 2 AM UTC
  workflow_dispatch:
    inputs:
      max_age_days:
        description: "Maximum age in days (default: 90 = 3 months)"
        required: false
        default: "90"
      dry_run:
        description: "Dry run (don't actually delete)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  cleanup:
    name: üßπ Cleanup Old Images
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîê Setup SSH
        run: |
          set -euo pipefail

          # Validate secrets
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ùå VPS_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_HOST }}" ]; then
            echo "‚ùå VPS_SSH_HOST secret is not set"
            exit 1
          fi

          # Setup SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Scan SSH host keys with retry (5 attempts for GitHub runner stability)
          echo "üîç Scanning SSH host keys for ${{ secrets.VPS_SSH_HOST }}..."
          for i in {1..5}; do
            if ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts 2>/tmp/ssh-scan-err; then
              echo "‚úÖ SSH host keys retrieved (attempt $i/5)"
              break
            else
              echo "‚ö†Ô∏è Attempt $i/5 failed:"
              cat /tmp/ssh-scan-err || true
              if [ $i -eq 5 ]; then
                echo "‚ùå Cannot reach SSH host after 5 attempts"
                echo "Check: VPS firewall, SSH port 22, VPS_SSH_HOST secret"
                exit 1
              fi
              sleep 3
            fi
          done

      - name: üßπ Run cleanup script
        run: |
          MAX_AGE="${{ github.event.inputs.max_age_days || '90' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          echo "üßπ Registry Cleanup"
          echo "=================="
          echo "Max age: ${MAX_AGE} days"
          echo "Dry run: ${DRY_RUN}"
          echo ""

          # Upload script to VPS
          scp -i ~/.ssh/deploy_key scripts/cleanup-registry-images.sh \
            ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}:/tmp/cleanup-registry.sh

          # Execute cleanup on VPS
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} << 'CLEANUP'
            set -e

            chmod +x /tmp/cleanup-registry.sh

            echo "üîç Running cleanup script..."
            /tmp/cleanup-registry.sh \
              registry.freijstack.com \
              ${{ secrets.REGISTRY_USER_PROD }} \
              '${{ secrets.REGISTRY_PASSWORD_PROD }}' \
              ${{ github.event.inputs.max_age_days || '90' }}

            echo ""
            echo "üóëÔ∏è  Running garbage collection..."
            cd /srv/www/registry
            docker compose exec -T registry bin/registry garbage-collect /etc/docker/registry/config.yml --delete-untagged

            echo ""
            echo "‚úÖ Cleanup completed"

            rm -f /tmp/cleanup-registry.sh
          CLEANUP

      - name: üßπ Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key || true

      - name: üìä Summary
        run: |
          {
            echo "## üßπ Registry Cleanup Summary"
            echo ""
            echo "- Max age: **${{ github.event.inputs.max_age_days || '90' }} days**"
            echo "- Dry run: **${{ github.event.inputs.dry_run || 'false' }}**"
            echo ""
            echo "‚úÖ Cleanup completed successfully"
          } >> "$GITHUB_STEP_SUMMARY"
