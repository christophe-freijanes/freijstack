name: üè• Production Health Check

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:
    inputs:
      auto_heal:
        description: "üîß Red√©marrer automatiquement si probl√®me d√©tect√©"
        required: false
        default: true
        type: boolean
  push:
    branches: [master]

concurrency:
  group: production-healthcheck
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  health-check:
    name: üè• Check Production Health
    runs-on: ubuntu-latest
    timeout-minutes: 6

    outputs:
      backend_status: ${{ steps.backend.outputs.status }}
      db_status: ${{ steps.database.outputs.status }}

    steps:
      - name: üß∞ Prepare tools
        run: |
          set -euo pipefail
          echo "üß∞ Tools versions"
          curl --version | head -n 1

      - name: üåê Check Public URLs (Portfolio + SecureVault)
        id: public-urls
        run: |
          set -euo pipefail

          URLS=(
            "https://portfolio.freijstack.com"
            "https://christophe-freijanes.github.io/freijstack/portfolio/"
            "https://vault.freijstack.com"
          )

          echo "## üåê Public URLs" >> "$GITHUB_STEP_SUMMARY"

          for url in "${URLS[@]}"; do
            echo "üîé Checking $url ..."

            code=$(
              curl -s -o /dev/null -w "%{http_code}" \
                --max-time 15 \
                --retry 2 --retry-delay 2 --retry-all-errors \
                "$url" || echo "000"
            )

            # ‚úÖ OK codes: 200/301/302
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "‚úÖ $url OK (HTTP $code)"
              echo "- ‚úÖ $url (HTTP $code)" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "‚ùå $url DOWN (HTTP $code)"
              echo "- ‚ùå $url (HTTP $code)" >> "$GITHUB_STEP_SUMMARY"
              exit 1
            fi
          done

      - name: üîé Check Backend SecureVault API (/api/health)
        id: backend
        run: |
          set -euo pipefail

          echo "## üß† Backend API" >> "$GITHUB_STEP_SUMMARY"

          url="https://vault-api.freijstack.com/api/health"
          echo "üîé Checking $url ..."

          code=$(
            curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              --retry 2 --retry-delay 2 --retry-all-errors \
              "$url" || echo "000"
          )

          if [ "$code" = "200" ]; then
            echo "‚úÖ Backend API OK (HTTP $code)"
            echo "status=healthy" >> "$GITHUB_OUTPUT"
            echo "- ‚úÖ API healthy (HTTP $code)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚ùå Backend API DOWN (HTTP $code)"
            echo "status=unhealthy" >> "$GITHUB_OUTPUT"
            echo "- ‚ùå API unhealthy (HTTP $code)" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

      - name: üîê Setup SSH (for DB check)
        id: ssh
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts

          # Quick SSH sanity check
          ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o ConnectTimeout=10 \
            "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}" "echo '‚úÖ SSH OK'"

      - name: üóÑÔ∏è Check Database Connectivity (pg_isready)
        id: database
        run: |
          set -euo pipefail
          echo "## üóÑÔ∏è Database" >> "$GITHUB_STEP_SUMMARY"

          SSH="ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o ConnectTimeout=10 ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"
          PROD_DIR="/srv/www/securevault/saas/securevault"

          echo "üóÑÔ∏è Checking PostgreSQL (pg_isready)..."

          # Debug context: show compose ps first (helps when failing)
          $SSH "cd '$PROD_DIR' && docker compose ps" || true

          db_status=$(
            $SSH "cd '$PROD_DIR' && docker compose exec -T postgres pg_isready -U securevault" 2>&1 || echo "FAILED"
          )

          if echo "$db_status" | grep -q "accepting connections"; then
            echo "‚úÖ Database OK"
            echo "status=healthy" >> "$GITHUB_OUTPUT"
            echo "- ‚úÖ DB accepting connections" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚ùå Database DOWN"
            echo "üîé pg_isready output: $db_status"
            echo "status=unhealthy" >> "$GITHUB_OUTPUT"
            echo "- ‚ùå DB not ready" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

      - name: üßπ Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key || true

  auto-heal:
    name: üîß Auto-Heal Production
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: health-check

    # ‚úÖ auto-heal uniquement si:
    # - health-check a √©chou√©
    # - event = schedule, OU workflow_dispatch avec auto_heal=true
    if: >
      always() &&
      needs.health-check.result == 'failure' &&
      (
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && inputs.auto_heal == true)
      )

    steps:
      - name: üîê Setup SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: ‚è±Ô∏è Auto-Heal cooldown check (anti restart-loop)
        id: cooldown
        run: |
          set -euo pipefail

          SSH="ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o ConnectTimeout=10 ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"
          PROD_DIR="/srv/www/securevault/saas/securevault"
          COOLDOWN_SECONDS=1800  # 30 minutes
          STAMP_FILE="/tmp/securevault_last_heal"

          echo "‚è±Ô∏è Checking cooldown..."

          now=$($SSH "date +%s")
          last=$($SSH "test -f '$STAMP_FILE' && cat '$STAMP_FILE' || echo 0")

          diff=$((now - last))

          if [ "$diff" -lt "$COOLDOWN_SECONDS" ]; then
            echo "üõë Cooldown active: last heal was $diff seconds ago (< $COOLDOWN_SECONDS)."
            echo "can_heal=false" >> "$GITHUB_OUTPUT"
            exit 0
          else
            echo "‚úÖ Cooldown passed. Auto-heal allowed."
            echo "can_heal=true" >> "$GITHUB_OUTPUT"
          fi

      - name: üîß Restart Production Services
        if: ${{ steps.cooldown.outputs.can_heal == 'true' }}
        run: |
          set -euo pipefail

          SSH="ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o ConnectTimeout=10 ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"
          PROD_DIR="/srv/www/securevault/saas/securevault"
          STAMP_FILE="/tmp/securevault_last_heal"

          echo "üö® Health check failed ‚Äî attempting auto-heal..."

          $SSH << 'HEAL_SCRIPT'
            set -euo pipefail

            PROD_DIR="/srv/www/securevault/saas/securevault"
            STAMP_FILE="/tmp/securevault_last_heal"

            cd "$PROD_DIR"

            echo "üìä Current container status:"
            docker compose ps || true
            echo ""

            echo "üîÑ Restarting all production services..."
            docker compose restart

            echo "‚è≥ Waiting for services to stabilize..."
            sleep 25

            echo "üìä New container status:"
            docker compose ps || true
            echo ""

            echo "üîé Checking backend health (internal)..."
            backend_health=$(docker compose exec -T backend curl -s http://localhost:3001/api/health || echo "FAILED")

            if echo "$backend_health" | grep -qi "ok"; then
              echo "‚úÖ Auto-heal successful!"
              date +%s > "$STAMP_FILE"
            else
              echo "‚ö†Ô∏è  Restart done but health still failing"
              echo "backend_health=$backend_health"
              exit 1
            fi
          HEAL_SCRIPT

      - name: üßπ Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key || true

  notify:
    name: üì¢ Health Status Notification
    runs-on: ubuntu-latest
    needs: [health-check, auto-heal]
    if: always()
    timeout-minutes: 3

    steps:
      - name: üìä Summary
        run: |
          set -euo pipefail

          echo "## üì¢ Production Health Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- üè• Health Check: **${{ needs.health-check.result }}**" >> "$GITHUB_STEP_SUMMARY"
          echo "- üîß Auto-Heal: **${{ needs.auto-heal.result }}**" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "‚úÖ Production is **HEALTHY**" >> "$GITHUB_STEP_SUMMARY"
            echo "- üéØ https://vault.freijstack.com" >> "$GITHUB_STEP_SUMMARY"
            echo "- üéØ https://vault-api.freijstack.com" >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ needs.auto-heal.result }}" = "success" ]; then
            echo "‚ö†Ô∏è Production had issues but **auto-heal succeeded**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "üö® **CRITICAL**: Health check failed and auto-heal did not recover" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: üì£ Console output
        run: |
          echo "üè• Health Check: ${{ needs.health-check.result }}"
          echo "üîß Auto-Heal: ${{ needs.auto-heal.result }}"
