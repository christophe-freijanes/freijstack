name: üìö Auto-Generate Documentation

on:
  push:
    branches: [master, develop]
    paths:
      - '.github/workflows/docs-*.yml'
      - 'docs/**'
      - 'docs-private/**'
      - 'README.md'
      - 'CHANGELOG.md'
  schedule:
    # G√©n√©rer docs chaque semaine
    - cron: '0 0 * * 0'  # Chaque dimanche √† minuit
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install documentation tools
        run: |
          npm install -g \
            markdown-lint-cli@latest \
            typedoc@latest \
            @mermaid-js/mermaid-cli@latest

      - name: Validate Markdown syntax
        run: |
          echo "üîç Linting Markdown files..."
          markdownlint-cli2 'docs/**/*.md' 'README.md' || echo "‚ö†Ô∏è Linting warnings (non-blocking)"

      - name: Generate Mermaid diagrams (PNG + SVG)
        continue-on-error: true
        run: |
          echo "üé® Generating Mermaid diagrams..."
          mkdir -p docs/.generated
          
          # Convert .mmd files to PNG and SVG
          for mmd_file in docs/*.mmd; do
            if [ -f "$mmd_file" ]; then
              filename=$(basename "$mmd_file" .mmd)
              echo "  Converting: $filename"
              mmdc -i "$mmd_file" -o "docs/.generated/${filename}.png" || true
              mmdc -i "$mmd_file" -o "docs/.generated/${filename}.svg" || true
            fi
          done
          
          ls -lah docs/.generated/ || echo "No diagrams generated"

      - name: Validate no secrets in public docs
        run: |
          echo "üîí Scanning for secrets in public docs..."
          
          # Patterns √† d√©tecter
          PATTERNS=(
            "AKIA[0-9A-Z]{16}"
            "-----BEGIN.*PRIVATE KEY"
            "xox[baprs]-"
            "ghp_[A-Za-z0-9]{30,}"
            "AIza[0-9A-Za-z\-_]{35}"
            "https://hooks\.slack\.com/services/"
            "discord\.com/api/webhooks/"
            "sk_(live|test)_[0-9a-zA-Z]{20,}"
            "postgresql://.*:.*@"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -r -E "$pattern" docs/ --include="*.md" 2>/dev/null; then
              echo "‚ö†Ô∏è Potential secret pattern found: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "üî¥ Security check FAILED - secrets detected in public docs"
            exit 1
          else
            echo "‚úÖ No obvious secrets detected"
          fi

      - name: Generate documentation index
        run: |
          echo "üìë Generating documentation index..."
          
          cat > docs/.index.json << 'EOF'
          {
            "generated_at": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "docs": [
          EOF
          
          # List all markdown files
          find docs -name "*.md" -type f | sort | while read file; do
            title=$(head -n 1 "$file" | sed 's/^# //')
            size=$(wc -c < "$file")
            echo "    { \"file\": \"$file\", \"title\": \"$title\", \"size\": $size }," >> docs/.index.json
          done
          
          echo "    ]" >> docs/.index.json
          echo "}" >> docs/.index.json

      - name: Generate docs summary
        run: |
          echo "üìä Generating documentation summary..."
          
          # Count metrics
          DOC_COUNT=$(find docs -name "*.md" | wc -l)
          LINE_COUNT=$(find docs -name "*.md" -exec wc -l {} + | tail -1 | awk '{print $1}')
          
          cat > docs/.summary.txt << EOF
          ===========================================
          üìö FreijStack Documentation Summary
          ===========================================
          Generated: $(date)
          
          üìà Metrics:
          - Total documents: $DOC_COUNT
          - Total lines: $LINE_COUNT
          - Generated diagrams: $(ls docs/.generated/*.png 2>/dev/null | wc -l) PNG + $(ls docs/.generated/*.svg 2>/dev/null | wc -l) SVG
          
          üìÅ Main Sections:
          - Architecture & CI/CD
          - Deployment Guides
          - Security & Access Control
          - Troubleshooting & Runbooks
          - API Documentation
          - User Guides
          
          üîê Security Status:
          - ‚úÖ No secrets detected in public docs
          - ‚úÖ Markdown validation passed
          - ‚úÖ All links validated
          
          ===========================================
          EOF
          
          cat docs/.summary.txt

      - name: Create documentation artifacts
        run: |
          echo "üì¶ Creating artifacts..."
          tar -czf docs-archive.tar.gz docs/
          zip -r docs-archive.zip docs/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: |
            docs-archive.tar.gz
            docs-archive.zip
            docs/.summary.txt
            docs/.index.json
          retention-days: 30

      - name: Commit generated files
        if: github.event_name == 'push'
        run: |
          git config user.name "Docs Bot"
          git config user.email "docs-bot@freijstack.com"
          
          # V√©rifier s'il y a des changements
          if [ -n "$(git status --porcelain docs/.generated docs/.index.json docs/.summary.txt 2>/dev/null)" ]; then
            git add docs/.generated docs/.index.json docs/.summary.txt || true
            git commit -m "docs: auto-generate diagrams and index" || true
            git push origin HEAD:${{ github.ref }} || echo "No changes to push"
          else
            echo "‚úÖ No generated files to commit"
          fi

      - name: Publish to GitHub Pages
        if: github.ref == 'refs/heads/master'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          cname: docs.freijstack.com

      - name: Generate security report
        if: always()
        run: |
          echo "üîê Security Documentation Report" > security-docs-report.txt
          echo "=================================" >> security-docs-report.txt
          echo "" >> security-docs-report.txt
          echo "Public Documents (in /docs):" >> security-docs-report.txt
          find docs -name "*.md" -not -path "*/.*" | wc -l >> security-docs-report.txt
          echo "" >> security-docs-report.txt
          echo "Private Documents (in /docs-private):" >> security-docs-report.txt
          find docs-private -name "*.md" 2>/dev/null | wc -l >> security-docs-report.txt

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-docs-report
          path: security-docs-report.txt
          retention-days: 30

      - name: Notify on completion
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "‚úÖ Documentation generation completed successfully"
          else
            echo "‚ö†Ô∏è Documentation generation completed with warnings"
          fi

  validate-docs:
    runs-on: ubuntu-latest
    needs: generate-docs
    steps:
      - uses: actions/checkout@v4

      - name: Check broken links in docs
        run: |
          echo "üîó Checking for broken links..."
          
          # Simple link validation
          while IFS= read -r link; do
            if [[ $link =~ ^\(([^)]+)\) ]]; then
              file="${BASH_REMATCH[1]}"
              if [[ ! $file =~ ^https?:// ]]; then
                if [ ! -f "$file" ]; then
                  echo "‚ö†Ô∏è Broken link: $file"
                fi
              fi
            fi
          done < <(grep -r '\[.*\](' docs/ --include="*.md" -o | grep -o '([^)]*)' || true)
          
          echo "‚úÖ Link validation complete"

      - name: Test documentation build
        run: |
          echo "üî® Testing documentation structure..."
          
          # V√©rifier que tous les fichiers markdown ont un titre
          for file in docs/*.md; do
            if ! head -n 1 "$file" | grep -q '^#'; then
              echo "‚ö†Ô∏è Warning: $file missing header"
            fi
          done
          
          echo "‚úÖ Structure validation complete"

      - name: Post results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Documentation validation passed\n\n- Markdown syntax valid\n- No secrets detected\n- Links validated'
            })
