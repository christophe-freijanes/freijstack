name: ğŸ§ª Health Check Development 

on:
  workflow_dispatch:
    inputs:
      auto_heal:
        description: "ğŸ”§ (DEV) RedÃ©marrer automatiquement si problÃ¨me dÃ©tectÃ©"
        required: false
        default: false
        type: boolean

  push:
    branches: [develop]

  # DEV: monitoring lÃ©ger
  schedule:
    - cron: "0 * * * *" # toutes les heures

concurrency:
  group: development-health-check
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  health-check:
    name: ğŸ§ª Check Dev Health
    runs-on: ubuntu-latest
    timeout-minutes: 6

    steps:
      - name: ğŸ“¥ Checkout repository (develop commit)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Secret scanning (Gitleaks CLI)
        id: gitleaks
        run: |
          set -euo pipefail

          echo "â¬‡ï¸ Installing gitleaks (pinned version)..."
          GITLEAKS_VERSION="8.21.2"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" \
            | tar -xz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks

          echo "ğŸ” Running gitleaks (redacted)..."
          gitleaks detect \
            --source . \
            --config .gitleaks.toml \
            --redact \
            --report-format json \
            --report-path gitleaks-report.json \
            --verbose || true

          test -f gitleaks-report.json || echo "[]" > gitleaks-report.json

          echo ""
          echo "ğŸ“„ Findings (metadata only):"
          if [ -s gitleaks-report.json ]; then
            jq -r '.[] | "\(.RuleID) file=\(.File) line=\(.StartLine) commit=\(.Commit|tostring|.[0:8])"' gitleaks-report.json | nl -w2 -s'. '
            leaks_count="$(jq 'length' gitleaks-report.json)"
          else
            echo "âœ… No findings."
            leaks_count="0"
          fi

          echo "leaks_count=${leaks_count}" >> "$GITHUB_OUTPUT"
          echo "ğŸ”¢ leaks_count=${leaks_count}"

      - name: ğŸ“ Upload gitleaks report (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report-dev
          path: gitleaks-report.json
          retention-days: 7
          if-no-files-found: error

      - name: ğŸŒ Check Public URLs (DEV signal)
        id: public-urls
        run: |
          set -euo pipefail

          echo "## ğŸŒ Dev URLs Health Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          MAX_RETRIES=3
          SLEEP_BETWEEN=7

          URLS=(
            "https://portfolio.freijstack.com|200,301,302|Portfolio"
            "https://christophe-freijanes.github.io/freijstack/|200,301,302|GitHub Pages"
            "https://vault.freijstack.com/login|200,301,302,404|SecureVault Frontend (shared)"
          )

          for entry in "${URLS[@]}"; do
            url="${entry%%|*}"
            rest="${entry#*|}"
            allowed="${rest%%|*}"
            label="${rest##*|}"

            echo ""
            echo "ğŸ” Checking $label â†’ $url"
            echo "- **$label** ($url)" >> "$GITHUB_STEP_SUMMARY"

            attempt=1
            success=false

            while [ "$attempt" -le "$MAX_RETRIES" ]; do
              echo "  â³ Attempt $attempt/$MAX_RETRIES..."

              code=$(
                curl -s -L -o /dev/null -w "%{http_code}" \
                  --max-time 15 \
                  "$url" || echo "000"
              )

              if echo ",$allowed," | grep -q ",$code,"; then
                echo "  âœ… OK (HTTP $code)"
                echo "  - âœ… HTTP $code (attempt $attempt)" >> "$GITHUB_STEP_SUMMARY"
                success=true
                break
              else
                echo "  âš ï¸  HTTP $code (attempt $attempt)"
                if [ "$attempt" -lt "$MAX_RETRIES" ]; then
                  echo "  â±ï¸ Waiting ${SLEEP_BETWEEN}s before retry..."
                  sleep "$SLEEP_BETWEEN"
                fi
              fi

              attempt=$((attempt + 1))
            done

            if [ "$success" != "true" ]; then
              echo "âŒ $label is DOWN after $MAX_RETRIES attempts"
              echo "  - âŒ Failed after $MAX_RETRIES attempts" >> "$GITHUB_STEP_SUMMARY"
              exit 1
            fi
          done

      - name: ğŸ” Check Backend API (/api/health) (shared)
        id: backend
        run: |
          set -euo pipefail
          echo "## ğŸ§  Backend API (shared)" >> "$GITHUB_STEP_SUMMARY"

          url="https://vault-api.freijstack.com/api/health"
          code=$(
            curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              --retry 2 --retry-delay 2 --retry-all-errors \
              "$url" || echo "000"
          )

          if [ "$code" = "200" ]; then
            echo "âœ… API OK (HTTP $code)"
            echo "- âœ… API healthy (HTTP $code)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ API DOWN (HTTP $code)"
            echo "- âŒ API unhealthy (HTTP $code)" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: echo "âœ… Cleanup done"

  auto-heal:
    name: ğŸ”§ Auto-Heal (manual only)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: health-check

    # âœ… DEV: auto-heal UNIQUEMENT manuel (sinon Ã§a masque les rÃ©gressions)
    if: >
      always() &&
      needs.health-check.result == 'failure' &&
      github.event_name == 'workflow_dispatch' &&
      inputs.auto_heal == true

    steps:
      - name: ğŸ” Setup SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: ğŸ”§ Restart services (DEV/shared) â€” example
        run: |
          echo "ğŸ§¯ Manual auto-heal triggered (DEV/shared)."
          echo "â¡ï¸ Ici tu mets tes commandes SSH si tu as un environnement DEV."
