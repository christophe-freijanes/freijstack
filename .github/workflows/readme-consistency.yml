name: README Consistency

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check-readmes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45

      - name: Enforce README updates per folder
        run: |
          set -e
          echo "Changed files:" 
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

          CHANGED=( ${{ steps.changed-files.outputs.all_changed_files }} )
          # Folders to enforce
          FOLDERS=(
            "docs"
            "portfolio"
            "saas"
            "saas/app1"
            "saas/app2"
          )

          FAILURES=()
          for DIR in "${FOLDERS[@]}"; do
            DIR_CHANGED=false
            README_CHANGED=false
            for f in "${CHANGED[@]}"; do
              if [[ "$f" == "$DIR/"* ]]; then
                DIR_CHANGED=true
                if [[ "$f" == "$DIR/README.md" ]]; then
                  README_CHANGED=true
                fi
              fi
            done
            if [[ "$DIR_CHANGED" == true && "$README_CHANGED" != true ]]; then
              FAILURES+=("$DIR")
            fi
          done

          if [[ ${#FAILURES[@]} -gt 0 ]]; then
            echo "README not updated for folders: ${FAILURES[*]}"
            echo "Please update the corresponding README.md files."
            exit 1
          else
            echo "README consistency check passed."
          fi