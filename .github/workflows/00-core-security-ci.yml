name: ğŸ›¡ï¸ Security CI (Core Orchestrator)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (staging|production|pr)"
        required: true
        type: string

      scan_paths:
        description: "Paths to scan (newline-separated)."
        required: false
        type: string
        default: |
          saas
          base-infra
          docs
          scripts

      # --- Optional components toggles ---
      run_codeql:
        description: "Run CodeQL SAST"
        required: false
        type: boolean
        default: true

      run_inspector:
        description: "Run Inspector (Gitleaks + Trivy FS + optional lint/audit)"
        required: false
        type: boolean
        default: true

      run_trivy_image:
        description: "Run Trivy image scan (requires trivy_images input)"
        required: false
        type: boolean
        default: false

      trivy_images:
        description: "Container images to scan (newline-separated, FULL refs). Example: registry-ui.freijstack.com/app:tag"
        required: false
        type: string
        default: ""

      registry_host:
        description: "Registry host for docker login (e.g., registry-ui.freijstack.com)."
        required: false
        type: string
        default: "registry-ui.freijstack.com"

      run_zap:
        description: "Run OWASP ZAP baseline (DAST) (requires dast_url input)"
        required: false
        type: boolean
        default: false

      dast_url:
        description: "Public URL to scan with OWASP ZAP (e.g., https://vault.freijstack.com)."
        required: false
        type: string
        default: ""

      # --- Gating ---
      gate_prod_only:
        description: "If true, enforce hard-fail gates only when environment == production."
        required: false
        type: boolean
        default: true

      fail_on_gitleaks:
        description: "Fail if gitleaks finds leaks (effective when gate is active)."
        required: false
        type: boolean
        default: true

      trivy_severity_gate:
        description: "Trivy severity threshold for gating (e.g., HIGH,CRITICAL)."
        required: false
        type: string
        default: "HIGH,CRITICAL"

      # --- Optional Snyk (requires secret SNYK_TOKEN) ---
      run_snyk:
        description: "Run Snyk (requires SNYK_TOKEN secret)."
        required: false
        type: boolean
        default: false

    secrets:
      SNYK_TOKEN:
        required: false

      # Registry creds (needed for private image pulls/scans)
      REGISTRY_USER_PROD:
        required: false
      REGISTRY_PASSWORD_PROD:
        required: false
      REGISTRY_USER_STAGING:
        required: false
      REGISTRY_PASSWORD_STAGING:
        required: false

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: security-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gate:
    name: ğŸ§­ Resolve gating mode
    runs-on: ubuntu-latest
    outputs:
      gate_active: ${{ steps.gate.outputs.gate_active }}
    steps:
      - id: gate
        run: |
          set -euo pipefail
          env="${{ inputs.environment }}"
          gate_prod_only="${{ inputs.gate_prod_only }}"
          gate_active="false"

          if [ "$gate_prod_only" = "true" ] && [ "$env" = "production" ]; then
            gate_active="true"
          elif [ "$gate_prod_only" = "false" ]; then
            gate_active="true"
          fi

          echo "gate_active=$gate_active" >> "$GITHUB_OUTPUT"
          echo "Gate active: $gate_active (env=$env, gate_prod_only=$gate_prod_only)" >> "$GITHUB_STEP_SUMMARY"

  codeql:
    name: ğŸ§  CodeQL
    needs: [gate]
    if: ${{ inputs.run_codeql }}
    uses: ./.github/workflows/01-security-codeql.yml
    with:
      environment: ${{ inputs.environment }}
    secrets: inherit

  gitleaks:
    name: ğŸ§ª Gitleaks (CLI, no external action)
    needs: [gate]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install gitleaks
        run: |
          set -euo pipefail
          VERSION="8.21.2"
          curl -sSL -o gitleaks.tgz "https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz"
          tar -xzf gitleaks.tgz gitleaks
          sudo install -m 0755 gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: ğŸ” Run gitleaks (SARIF)
        id: scan
        continue-on-error: true
        run: |
          set -euo pipefail
          gitleaks detect \
            --source . \
            --redact \
            --report-format sarif \
            --report-path gitleaks.sarif \
            --exit-code 1

      - name: ğŸ“¤ Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gitleaks.sarif
          category: gitleaks

      - name: âœ… Enforce gitleaks gate (optional)
        if: ${{ needs.gate.outputs.gate_active == 'true' && inputs.fail_on_gitleaks == true }}
        run: |
          set -euo pipefail
          # If gitleaks step failed, fail the job now (gate mode)
          if [ "${{ steps.scan.outcome }}" != "success" ]; then
            echo "Gitleaks detected leaks and gate is active. Failing." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
          echo "Gitleaks gate passed." >> "$GITHUB_STEP_SUMMARY"

  snyk:
    name: ğŸ§ª Snyk (optional)
    needs: [gate]
    if: ${{ inputs.run_snyk }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # NOTE: If your Actions allowlist does not include "snyk/*", this will be blocked.
      - name: ğŸ§ª Snyk test
        uses: snyk/actions@master
        with:
          command: test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - name: ğŸ“¤ Upload Snyk results (artifact)
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: snyk-results
          path: snyk*.*
        continue-on-error: true

  trivy-image-list:
    name: ğŸ³ Build Trivy image list
    needs: [gate]
    if: ${{ inputs.run_trivy_image && inputs.trivy_images != '' }}
    runs-on: ubuntu-latest
    outputs:
      images_json: ${{ steps.images.outputs.images_json }}
    steps:
      - name: ğŸ§¾ Build image list (newline â†’ JSON array)
        id: images
        run: |
          set -euo pipefail
          json=$(
            printf "%s" "${{ inputs.trivy_images }}" \
            | sed '/^\s*$/d' \
            | jq -R -s -c 'split("\n") | map(select(length>0))'
          )
          echo "images_json=$json" >> "$GITHUB_OUTPUT"
          echo "Images: $json" >> "$GITHUB_STEP_SUMMARY"

  trivy-image:
    name: ğŸ³ Trivy â€¢ Image scan (private registry)
    needs: [gate, trivy-image-list]
    if: ${{ inputs.run_trivy_image && inputs.trivy_images != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJSON(needs.trivy-image-list.outputs.images_json) }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¾ Derive registry host from image
        id: reg
        run: |
          set -euo pipefail
          img="${{ matrix.image }}"
          host="$(printf "%s" "$img" | awk -F/ '{print $1}')"
          echo "host=$host" >> "$GITHUB_OUTPUT"
          echo "Derived registry host: $host" >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸ” Docker login (private registry) - required
        run: |
          set -euo pipefail
          host="${{ steps.reg.outputs.host }}"
          env="${{ inputs.environment }}"

          if [ "$env" = "staging" ]; then
            user="${{ secrets.REGISTRY_USER_STAGING }}"
            pass="${{ secrets.REGISTRY_PASSWORD_STAGING }}"
          else
            user="${{ secrets.REGISTRY_USER_PROD }}"
            pass="${{ secrets.REGISTRY_PASSWORD_PROD }}"
          fi

          if [ -z "${user:-}" ] || [ -z "${pass:-}" ]; then
            echo "âŒ Missing registry credentials for env=$env (host=$host). Cannot pull private images." >&2
            exit 1
          fi

          echo "$pass" | docker login "$host" -u "$user" --password-stdin
          echo "âœ… Logged in to $host for env=$env" >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸ§ª Pull image (verify tag exists)
        run: |
          set -euo pipefail
          echo "Pulling ${{ matrix.image }}"
          docker pull "${{ matrix.image }}"

      - name: ğŸ›¡ï¸ Trivy image scan â†’ SARIF (+ gate via exit-code)
        id: trivy
        uses: aquasecurity/trivy-action@0.30.0
        with:
          scan-type: "image"
          image-ref: "${{ matrix.image }}"
          format: "sarif"
          output: "trivy-image-${{ strategy.job-index }}.sarif"
          severity: "${{ inputs.trivy_severity_gate }}"
          ignore-unfixed: true
          vuln-type: "os,library"
          exit-code: ${{ needs.gate.outputs.gate_active == 'true' && '1' || '0' }}
        env:
          TRIVY_USERNAME: ${{ inputs.environment == 'staging' && secrets.REGISTRY_USER_STAGING || secrets.REGISTRY_USER_PROD }}
          TRIVY_PASSWORD: ${{ inputs.environment == 'staging' && secrets.REGISTRY_PASSWORD_STAGING || secrets.REGISTRY_PASSWORD_PROD }}

      - name: ğŸ” Verify SARIF file
        id: sarif
        if: always()
        run: |
          set -euo pipefail
          f="trivy-image-${{ strategy.job-index }}.sarif"
          echo "Expected SARIF: $f" >> "$GITHUB_STEP_SUMMARY"
          ls -lah >> "$GITHUB_STEP_SUMMARY" || true
          if [ -f "$f" ] && [ -s "$f" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "âœ… SARIF exists and is not empty." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ SARIF missing or empty. Upload will be skipped." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: ğŸ§¾ Build safe SARIF category
        if: ${{ always() && steps.sarif.outputs.exists == 'true' }}
        id: cat
        run: |
          set -euo pipefail
          img="${{ matrix.image }}"
          safe="$(printf "%s" "$img" | sed -E 's/[^a-zA-Z0-9._-]+/-/g')"
          safe="$(printf "%.200s" "$safe")"
          echo "category=trivy-image-$safe" >> "$GITHUB_OUTPUT"
          echo "Category: trivy-image-$safe" >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸ“¤ Upload SARIF (Code Scanning)
        if: ${{ always() && steps.sarif.outputs.exists == 'true' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-image-${{ strategy.job-index }}.sarif"
          category: ${{ steps.cat.outputs.category }}
          wait-for-processing: true

  zap-dast:
    name: ğŸŒ OWASP ZAP (DAST)
    needs: [gate]
    if: ${{ inputs.run_zap && inputs.dast_url != '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: ğŸ§¾ Plan
        run: |
          set -euo pipefail
          echo "Target: ${{ inputs.dast_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Gate active: ${{ needs.gate.outputs.gate_active }}" >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸ•·ï¸ ZAP baseline scan (non-blocking)
        if: ${{ needs.gate.outputs.gate_active != 'true' }}
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: ${{ inputs.dast_url }}
          allow_issue_writing: false
          fail_action: false
          cmd_options: "-a"

      - name: ğŸ•·ï¸ ZAP baseline scan (blocking - gate)
        if: ${{ needs.gate.outputs.gate_active == 'true' }}
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: ${{ inputs.dast_url }}
          allow_issue_writing: false
          fail_action: true
          cmd_options: "-a"

      - name: ğŸ“ Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: zap-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 7
        continue-on-error: true
