name: ðŸ³ Registry Deploy (Staging & Production)

on:
  push:
    branches:
      - develop
      - master
    paths:
      - "saas/registry/**"
      - ".github/workflows/00-core-deploy-queue.yml"
      - ".github/workflows/03-app-registry-deploy.yml"

  workflow_dispatch:
    inputs:
      target_env:
        description: "Target environment to deploy"
        required: true
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  actions: read

env:
  APP_NAME: registry
  DEPLOY_DIR: /srv/www/registry
  PROJECT_PATH: saas/registry
  STAGING_COMPOSE: docker-compose.staging.yml
  PROD_COMPOSE: docker-compose.prod.yml
  STAGING_HOST: registry-staging.freijstack.com
  PROD_HOST: registry.freijstack.com
  STAGING_UI_HOST: registry-ui-staging.freijstack.com
  PROD_UI_HOST: registry-ui.freijstack.com

jobs:
  preflight:
    name: âœ… Preflight (resolve target)
    runs-on: ubuntu-latest
    outputs:
      target_env: ${{ steps.resolve.outputs.target_env }}
      compose_file: ${{ steps.resolve.outputs.compose_file }}
      registry_host: ${{ steps.resolve.outputs.registry_host }}
      registry_ui_host: ${{ steps.resolve.outputs.registry_ui_host }}
    steps:
      - name: Resolve target environment
        id: resolve
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "push" ]; then
            if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
              TARGET_ENV="staging"
            elif [ "${{ github.ref }}" = "refs/heads/master" ]; then
              TARGET_ENV="production"
            else
              echo "Unsupported branch for this workflow: ${{ github.ref }}"
              exit 1
            fi
          else
            TARGET_ENV="${{ inputs.target_env }}"
          fi

          if [ "$TARGET_ENV" = "staging" ]; then
            COMPOSE_FILE="${{ env.STAGING_COMPOSE }}"
            REGISTRY_HOST="${{ env.STAGING_HOST }}"
            REGISTRY_UI_HOST="${{ env.STAGING_UI_HOST }}"
          else
            COMPOSE_FILE="${{ env.PROD_COMPOSE }}"
            REGISTRY_HOST="${{ env.PROD_HOST }}"
            REGISTRY_UI_HOST="${{ env.PROD_UI_HOST }}"
          fi

          echo "target_env=$TARGET_ENV" >> "$GITHUB_OUTPUT"
          echo "compose_file=$COMPOSE_FILE" >> "$GITHUB_OUTPUT"
          echo "registry_host=$REGISTRY_HOST" >> "$GITHUB_OUTPUT"
          echo "registry_ui_host=$REGISTRY_UI_HOST" >> "$GITHUB_OUTPUT"

      - name: Job summary (preflight)
        run: |
          set -euo pipefail
          {
            echo "## ðŸ§­ Registry Deploy â€” Preflight"
            echo ""
            echo "- **Event**: \`${{ github.event_name }}\`"
            echo "- **Ref**: \`${{ github.ref }}\`"
            echo "- **Commit**: \`${{ github.sha }}\`"
            echo "- **Target Env**: \`${{ steps.resolve.outputs.target_env }}\`"
            echo "- **Deploy Dir (VPS)**: \`${{ env.DEPLOY_DIR }}\`"
            echo "- **Project Path**: \`${{ env.PROJECT_PATH }}\`"
            echo "- **Compose File**: \`${{ steps.resolve.outputs.compose_file }}\`"
            echo ""
            echo "### ðŸŒ Endpoints"
            echo "- Registry API: \`https://${{ steps.resolve.outputs.registry_host }}/v2/\`"
            echo "- Registry UI:  \`https://${{ steps.resolve.outputs.registry_ui_host }}/\`"
            echo ""
            echo "### ðŸ”’ Safety"
            echo "- Volumes are preserved (no \`down -v\` anywhere)."
            echo "- When deploying **production** for registry, orchestrator stops **staging** first (containers only)."
          } >> "$GITHUB_STEP_SUMMARY"

  deploy:
    name: ðŸš€ Deploy (via orchestrator)
    needs: preflight
    uses: ./.github/workflows/00-core-deploy-queue.yml
    with:
      app_name: registry
      environment: ${{ needs.preflight.outputs.target_env }}
      deploy_dir: /srv/www/registry
      project_path: saas/registry
      docker_compose_file: ${{ needs.preflight.outputs.compose_file }}
      run_migrations: false
      custom_script: ""
    secrets: inherit

  verify:
    name: ðŸ”Ž Post-deploy verification (3 attempts)
    needs: [preflight, deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Verify Registry API (/v2/) â€” 3 attempts
        run: |
          set -euo pipefail
          HOST="${{ needs.preflight.outputs.registry_host }}"
          URL="https://${HOST}/v2/"
          echo "Checking: $URL"

          OK=0
          for i in 1 2 3; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "attempt ${i}/3 -> HTTP ${CODE}"
            if [ "$CODE" = "200" ] || [ "$CODE" = "401" ]; then
              OK=1
              break
            fi
            sleep 3
          done

          if [ "$OK" -ne 1 ]; then
            echo "âŒ Registry API check failed after 3 attempts."
            echo "Headers:"
            curl -s -I "$URL" || true
            exit 1
          fi

          echo "âœ… Registry API OK"

      - name: Verify Registry UI (/) â€” 3 attempts
        run: |
          set -euo pipefail
          HOST="${{ needs.preflight.outputs.registry_ui_host }}"
          URL="https://${HOST}/"
          echo "Checking: $URL"

          OK=0
          for i in 1 2 3; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "attempt ${i}/3 -> HTTP ${CODE}"
            if [ "$CODE" = "200" ] || [ "$CODE" = "301" ] || [ "$CODE" = "302" ]; then
              OK=1
              break
            fi
            sleep 3
          done

          if [ "$OK" -ne 1 ]; then
            echo "âŒ Registry UI check failed after 3 attempts."
            echo "Headers:"
            curl -s -I "$URL" || true
            exit 1
          fi

          echo "âœ… Registry UI OK"

      - name: Job summary (post-deploy)
        run: |
          set -euo pipefail
          {
            echo "## âœ… Registry Deploy â€” Verified"
            echo ""
            echo "- **Target Env**: \`${{ needs.preflight.outputs.target_env }}\`"
            echo "- **Registry API**: âœ… \`https://${{ needs.preflight.outputs.registry_host }}/v2/\` (200/401)"
            echo "- **Registry UI**: âœ… \`https://${{ needs.preflight.outputs.registry_ui_host }}/\` (200/30x)"
            echo ""
            echo "### ðŸ§ª 3-attempts mode"
            echo "- API and UI were checked up to 3 times with short delays."
          } >> "$GITHUB_STEP_SUMMARY"
