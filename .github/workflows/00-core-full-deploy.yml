name: ðŸŽ¯ Deploy Queue (Orchestrator)

on:
  workflow_call:
    inputs:
      app_name:
        description: "Application name (portfolio, securevault, registry, etc.)"
        required: true
        type: string
      environment:
        description: "Target environment (staging or production)"
        required: true
        type: string
      deploy_dir:
        description: "VPS deployment directory"
        required: true
        type: string
      project_path:
        description: "Project subdirectory (e.g., saas/portfolio)"
        required: false
        type: string
        default: ""
      docker_compose_file:
        description: "Docker Compose file to use"
        required: false
        type: string
        default: "docker-compose.yml"
      run_migrations:
        description: "Run database migrations after deploy"
        required: false
        type: boolean
        default: false
      custom_script:
        description: "Custom deployment script (bash)"
        required: false
        type: string
        default: ""
      skip_security:
        description: "Compatibility flag (not used here)"
        required: false
        type: boolean
        default: false
      skip_lint:
        description: "Compatibility flag (not used here)"
        required: false
        type: boolean
        default: false

    secrets:
      VPS_SSH_KEY:
        required: true
      VPS_SSH_HOST:
        required: true
      VPS_SSH_USER:
        required: true

      # IMPORTANT: all registry creds are OPTIONAL here.
      # We validate at runtime depending on the target env and app.
      REGISTRY_USER_STAGING:
        required: false
      REGISTRY_PASSWORD_STAGING:
        required: false
      REGISTRY_USER_PROD:
        required: false
      REGISTRY_PASSWORD_PROD:
        required: false

concurrency:
  group: vps-ssh-deploy
  cancel-in-progress: false

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: ðŸš€ Deploy ${{ inputs.app_name }} to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: â±ï¸ Staggered Start (avoid SSH collisions)
        run: |
          set -euo pipefail
          DELAY=$((5 + RANDOM % 16))
          echo "â³ Waiting ${DELAY}s"
          sleep "$DELAY"

      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts || true
          echo "SSH_OPTIONS=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" >> "$GITHUB_ENV"

      - name: ðŸš€ Deploy ${{ inputs.app_name }}
        run: |
          set -euo pipefail

          SSH_TARGET="${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"
          BRANCH="${GITHUB_REF##*/}"

          REMOTE_ENV="APP_NAME='${{ inputs.app_name }}' \
          ENVIRONMENT='${{ inputs.environment }}' \
          DEPLOY_DIR='${{ inputs.deploy_dir }}' \
          PROJECT_PATH='${{ inputs.project_path }}' \
          COMPOSE_FILE='${{ inputs.docker_compose_file }}' \
          GH_REPO='${{ github.repository }}' \
          GH_BRANCH='${BRANCH}' \
          GH_SHA='${{ github.sha }}' \
          REGISTRY_HOST='registry.freijstack.com' \
          REGISTRY_USER_PROD='${{ secrets.REGISTRY_USER_PROD }}' \
          REGISTRY_PASSWORD_PROD='${{ secrets.REGISTRY_PASSWORD_PROD }}' \
          REGISTRY_USER_STAGING='${{ secrets.REGISTRY_USER_STAGING }}' \
          REGISTRY_PASSWORD_STAGING='${{ secrets.REGISTRY_PASSWORD_STAGING }}'"

          ssh $SSH_OPTIONS -i ~/.ssh/deploy_key "$SSH_TARGET" "$REMOTE_ENV" bash <<'DEPLOY_SCRIPT'
          set -euo pipefail
          export DOCKER_CLI_HINTS=false

          : "${APP_NAME:?}"
          : "${ENVIRONMENT:?}"
          : "${DEPLOY_DIR:?}"
          : "${COMPOSE_FILE:?}"
          : "${GH_REPO:?}"
          : "${GH_BRANCH:?}"
          : "${GH_SHA:?}"
          : "${REGISTRY_HOST:?}"
          : "${REGISTRY_USER_PROD:?}"
          : "${REGISTRY_PASSWORD_PROD:?}"

          if ! docker compose version >/dev/null 2>&1; then
            echo "âŒ Docker Compose not available on VPS"
            exit 1
          fi

          echo "ðŸ”’ Volume protection: enabled (never run docker compose down -v)"
          echo "ðŸš€ Deploying ${APP_NAME} â†’ ${ENVIRONMENT}"
          echo "ðŸ“ DEPLOY_DIR=${DEPLOY_DIR}"
          echo "ðŸ“„ COMPOSE_FILE=${COMPOSE_FILE}"
          echo "ðŸ”€ BRANCH=${GH_BRANCH}"
          echo "ðŸ§¾ SHA=${GH_SHA}"
          echo "ðŸ“¦ Registry host=${REGISTRY_HOST} (single registry strategy)"

          if ! docker compose version >/dev/null 2>&1; then
            echo "âŒ Docker Compose not available on VPS"
            exit 1
          fi

          echo "ðŸ”’ Volume protection: enabled (never run docker compose down -v)"
          echo "ðŸš€ Deploying ${APP_NAME} â†’ ${ENVIRONMENT}"
          echo "ðŸ“ DEPLOY_DIR=${DEPLOY_DIR}"
          echo "ðŸ“„ COMPOSE_FILE=${COMPOSE_FILE}"
          echo "ðŸ”€ BRANCH=${GH_BRANCH}"
          echo "ðŸ§¾ SHA=${GH_SHA}"

          mkdir -p "$DEPLOY_DIR"
          cd "$DEPLOY_DIR"

          if [ -d ".git" ]; then
            git fetch origin --tags
            git reset --hard "origin/${GH_BRANCH}"
            git clean -fd
          else
            git clone -b "${GH_BRANCH}" "https://github.com/${GH_REPO}.git" .
          fi

          if [ -n "${PROJECT_PATH:-}" ]; then
            cd "$PROJECT_PATH"
          fi

          if [ ! -f "$COMPOSE_FILE" ]; then
            echo "âŒ Compose file not found: $COMPOSE_FILE (cwd=$(pwd))"
            ls -lah
            exit 1
          fi

          # ==========================================================
          # Resolve which registry host to use for pulls (apps)
          # - production -> registry.freijstack.com
          # - staging    -> registry-staging.freijstack.com (if you run it)
          # If you DO NOT run staging registry anymore, keep pulls pointed to prod.
          # ==========================================================
          REGISTRY_HOST="registry.freijstack.com"
          if [ "$ENVIRONMENT" = "staging" ]; then
            # If you want staging to pull from staging registry, change this line:
            # REGISTRY_HOST="registry-staging.freijstack.com"
            REGISTRY_HOST="registry.freijstack.com"
          fi

          # ==========================================================
          # Registry app: generate htpasswd (requires env creds)
          # ==========================================================
          if [ "$APP_NAME" = "registry" ]; then
            # If you keep a staging registry someday:
            # - production uses PROD creds
            # - staging uses STAGING creds if present, otherwise PROD creds
            if [ "$ENVIRONMENT" = "production" ]; then
              USER="${REGISTRY_USER_PROD}"
              PASS="${REGISTRY_PASSWORD_PROD}"
            else
              USER="${REGISTRY_USER_STAGING:-$REGISTRY_USER_PROD}"
              PASS="${REGISTRY_PASSWORD_STAGING:-$REGISTRY_PASSWORD_PROD}"
            fi

            if [ -z "${USER}" ] || [ -z "${PASS}" ]; then
              echo "âŒ Registry deploy requires credentials for env=${ENVIRONMENT}"
              exit 1
            fi

            echo "ðŸ” Generating .htpasswd for registry (${ENVIRONMENT})"
            docker run --rm httpd:2 htpasswd -Bbn "$USER" "$PASS" > .htpasswd
            ls -lah .htpasswd
          fi

          # ==========================================================
          # Non-registry apps: docker login only if creds provided
          # (needed only when pulling private images)
          # ==========================================================
          if [ "$APP_NAME" != "registry" ]; then
            if [ "$ENVIRONMENT" = "production" ]; then
              LOGIN_USER="${REGISTRY_USER_PROD:-}"
              LOGIN_PASS="${REGISTRY_PASSWORD_PROD:-}"
            else
              LOGIN_USER="${REGISTRY_USER_STAGING:-}"
              LOGIN_PASS="${REGISTRY_PASSWORD_STAGING:-}"
            fi

            if [ -n "${LOGIN_USER}" ] && [ -n "${LOGIN_PASS}" ]; then
              echo "ðŸ” docker login ${REGISTRY_HOST} (env=${ENVIRONMENT})"
              echo "${LOGIN_PASS}" | docker login "${REGISTRY_HOST}" -u "${LOGIN_USER}" --password-stdin
            else
              echo "âš ï¸ No registry creds for env=${ENVIRONMENT}; compose pull may fail if images are private."
            fi
          fi

          # ==========================================================
          # Deploy logic (no volume deletion)
          # ==========================================================
          if [ "$ENVIRONMENT" = "production" ]; then
            echo "ðŸŸ¢ Production deploy: pull + up (no down)"
            docker compose -f "$COMPOSE_FILE" pull
            docker compose -f "$COMPOSE_FILE" up -d --remove-orphans
          else
            echo "ðŸŸ¡ Staging deploy: down (no -v) + pull + up"
            docker compose -f "$COMPOSE_FILE" down --remove-orphans || true
            docker compose -f "$COMPOSE_FILE" pull
            docker compose -f "$COMPOSE_FILE" up -d --build --remove-orphans
          fi

          echo "ðŸ“Š Containers:"
          docker compose -f "$COMPOSE_FILE" ps

          echo "ðŸ“¦ Volumes:"
          docker volume ls
          DEPLOY_SCRIPT

      - name: ðŸ—„ï¸ Run Migrations
        if: inputs.run_migrations
        run: |
          set -euo pipefail
          ssh $SSH_OPTIONS -i ~/.ssh/deploy_key \
            ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }} \
            "cd ${{ inputs.deploy_dir }}/${{ inputs.project_path }} && docker compose exec -T app npm run migrate || true"

      - name: âœ… Deployment Summary
        if: success()
        run: |
          set -euo pipefail
          echo "## âœ… Deployment Successful" >> "$GITHUB_STEP_SUMMARY"
          echo "- App: ${{ inputs.app_name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Env: ${{ inputs.environment }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commit: ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
