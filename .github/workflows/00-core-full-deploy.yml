name: ðŸ”’ Full Deploy (DevSecOps Pipeline)

# Orchestrateur DevSecOps complet : Security â†’ Lint â†’ Test â†’ Deploy
# Wrapper rÃ©utilisable qui garantit que le dÃ©ploiement respecte les standards SRE

on:
  workflow_call:
    inputs:
      # Application configuration
      app_name:
        description: 'Application name'
        required: true
        type: string
      environment:
        description: 'Target environment (staging or production)'
        required: true
        type: string
      deploy_dir:
        description: 'VPS deployment directory'
        required: true
        type: string
      project_path:
        description: 'Project subdirectory (e.g., saas/portfolio)'
        required: false
        type: string
        default: ''

      # Docker configuration
      docker_compose_file:
        description: 'Docker Compose file to use'
        required: false
        type: string
        default: 'docker-compose.yml'
      run_migrations:
        description: 'Run database migrations after deploy'
        required: false
        type: boolean
        default: false

      # Security & Quality configuration
      scan_paths:
        description: 'Paths to scan for security issues (multi-line)'
        required: false
        type: string
        default: '.'
      fail_on_gitleaks:
        description: 'Fail pipeline if secrets detected'
        required: false
        type: boolean
        default: true
      skip_security:
        description: 'Skip security scan (NOT RECOMMENDED)'
        required: false
        type: boolean
        default: false
      skip_lint:
        description: 'Skip linting (NOT RECOMMENDED)'
        required: false
        type: boolean
        default: false

      # Testing configuration
      test_command:
        description: 'Command to run tests (e.g., npm test)'
        required: false
        type: string
        default: ''
      skip_tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false

      # Custom deployment script
      custom_script:
        description: 'Custom deployment script (bash)'
        required: false
        type: string
        default: ''

    secrets:
      VPS_SSH_KEY:
        required: true
      VPS_SSH_HOST:
        required: true
      VPS_SSH_USER:
        required: true
      REGISTRY_PASSWORD_STAGING:
        required: false
      REGISTRY_USER_STAGING:
        required: false
      REGISTRY_USER_PROD:
        required: false
      REGISTRY_PASSWORD_PROD:
        required: false

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1ï¸âƒ£ SECURITY SCAN (Gitleaks + Trivy)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security:
    name: ðŸ›¡ï¸ Security Scan
    if: ${{ !inputs.skip_security }}
    uses: ./.github/workflows/01-security-gitleaks.yml
    permissions:
      contents: read
      actions: read
      security-events: write
    with:
      scan_paths: ${{ inputs.scan_paths }}
      fail_on_gitleaks: ${{ inputs.fail_on_gitleaks }}
      upload_sarif: true
      publish_score_artifact: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2ï¸âƒ£ LINT (Code Quality)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    name: ðŸ§¹ Lint Code
    if: ${{ !inputs.skip_lint }}
    needs: security
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Auto-detect and run linters
        run: |
          set -euo pipefail
          echo "ðŸ” Detecting linters for ${{ inputs.project_path || '.' }}..."

          PROJECT_DIR="${{ inputs.project_path }}"
          if [ -n "$PROJECT_DIR" ] && [ -d "$PROJECT_DIR" ]; then
            cd "$PROJECT_DIR"
          fi

          FAILED=0

          # JavaScript/TypeScript: ESLint
          if [ -f "package.json" ] && grep -q "eslint" package.json 2>/dev/null; then
            echo "ðŸ“¦ Running ESLint..."
            npm install --silent
            npm run lint --if-present || FAILED=1
          fi

          # Python: Ruff
          if find . -name "*.py" -type f | head -n 1 | grep -q .; then
            echo "ðŸ Running Ruff..."
            pip install -q ruff
            ruff check . || FAILED=1
          fi

          # Markdown: markdownlint
          if [ -f ".markdownlint-cli2.jsonc" ]; then
            echo "ðŸ“ Running markdownlint..."
            npm install -g markdownlint-cli2 --silent
            markdownlint-cli2 "**/*.md" || FAILED=1
          fi

          # Shell: ShellCheck
          if find . -name "*.sh" -type f | head -n 1 | grep -q .; then
            echo "ðŸš Running ShellCheck..."
            sudo apt-get install -qq shellcheck
            find . -name "*.sh" -type f -exec shellcheck {} + || FAILED=1
          fi

          # YAML: yamllint
          if find . -name "*.yml" -o -name "*.yaml" | head -n 1 | grep -q .; then
            echo "ðŸ“‹ Running yamllint..."
            pip install -q yamllint
            yamllint . || FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo "âŒ Linting failed"
            exit 1
          fi

          echo "âœ… All linters passed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3ï¸âƒ£ TEST & BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: ðŸ§ª Test & Build
    if: ${{ !inputs.skip_tests }}
    needs: [security, lint]
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ§ª Run tests
        if: inputs.test_command != ''
        run: |
          PROJECT_DIR="${{ inputs.project_path }}"
          if [ -n "$PROJECT_DIR" ] && [ -d "$PROJECT_DIR" ]; then
            cd "$PROJECT_DIR"
          fi

          echo "ðŸ§ª Running tests: ${{ inputs.test_command }}"
          ${{ inputs.test_command }}

      - name: ðŸ³ Build Docker images (validation)
        run: |
          PROJECT_DIR="${{ inputs.project_path }}"
          if [ -n "$PROJECT_DIR" ] && [ -d "$PROJECT_DIR" ]; then
            cd "$PROJECT_DIR"
          fi

          if [ -f "${{ inputs.docker_compose_file }}" ]; then
            echo "ðŸ³ Building Docker images for validation..."
            docker compose -f "${{ inputs.docker_compose_file }}" build
          else
            echo "âš ï¸ No Docker Compose file found, skipping build"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4ï¸âƒ£ DEPLOY (Via Centralized Queue)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ðŸš€ Deploy ${{ inputs.app_name }}
    needs: [security, lint, test]
    if: |
      always() &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    uses: ./.github/workflows/00-core-deploy-queue.yml
    with:
      app_name: ${{ inputs.app_name }}
      environment: ${{ inputs.environment }}
      deploy_dir: ${{ inputs.deploy_dir }}
      project_path: ${{ inputs.project_path }}
      docker_compose_file: ${{ inputs.docker_compose_file }}
      run_migrations: ${{ inputs.run_migrations }}
      custom_script: ${{ inputs.custom_script }}
    secrets:
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      VPS_SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
      VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}
      REGISTRY_PASSWORD_STAGING: ${{ secrets.REGISTRY_PASSWORD_STAGING }}
      REGISTRY_USER_STAGING: ${{ secrets.REGISTRY_USER_STAGING }}
      REGISTRY_USER_PROD: ${{ secrets.REGISTRY_USER_PROD }}
      REGISTRY_PASSWORD_PROD: ${{ secrets.REGISTRY_PASSWORD_PROD }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5ï¸âƒ£ SUMMARY & NOTIFICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ðŸ“Š Pipeline Summary
    needs: [security, lint, test, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ”’ DevSecOps Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application**: ${{ inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Security
          if [ "${{ needs.security.result }}" = "success" ]; then
            echo "- ðŸ›¡ï¸ Security: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.security.result }}" = "skipped" ]; then
            echo "- ðŸ›¡ï¸ Security: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ›¡ï¸ Security: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Lint
          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "- ðŸ§¹ Lint: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.lint.result }}" = "skipped" ]; then
            echo "- ðŸ§¹ Lint: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ§¹ Lint: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Test
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "- ðŸ§ª Test: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test.result }}" = "skipped" ]; then
            echo "- ðŸ§ª Test: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ§ª Test: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Deploy
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "- ðŸš€ Deploy: âœ… Success" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy.result }}" = "skipped" ]; then
            echo "- ðŸš€ Deploy: â­ï¸ Skipped (previous failure)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš€ Deploy: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "### âœ… Pipeline Successful" >> $GITHUB_STEP_SUMMARY
            echo "Application deployed successfully to ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Pipeline Failed" >> $GITHUB_STEP_SUMMARY
            echo "Deployment was not executed due to previous failures" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
