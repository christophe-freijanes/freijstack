name: ğŸ’¾ Scheduled Cloud Backup

on:
  schedule:
    # Tous les jours Ã  3h UTC (4h Paris en hiver, 5h en Ã©tÃ©)
    - cron: '0 3 * * *'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to backup'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      provider:
        description: 'Cloud provider (leave empty for auto-detect all)'
        required: false
        type: choice
        options:
          - auto
          - s3
          - azure
          - gcs
          - b2
          - spaces
          - wasabi

env:
  # Default to production for scheduled runs
  TARGET_ENV: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}
  PROVIDER: ${{ github.event_name == 'workflow_dispatch' && inputs.provider || 'auto' }}

jobs:
  security:
    name: ğŸ›¡ï¸ Shield â€¢ Guardian
    uses: ./.github/workflows/01-security-gitleaks.yml
    permissions:
      contents: read
      actions: read
      security-events: write
    with:
      scan_paths: |
        scripts
        .github
      fail_on_gitleaks: true
      upload_sarif: false
      publish_score_artifact: true

  backup-production:
    needs: security
    name: ğŸ’¾ Backup Production to Cloud
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH
        run: |
          set -euo pipefail
          
          # Validate secrets
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ VPS_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_HOST }}" ]; then
            echo "âŒ VPS_SSH_HOST secret is not set"
            exit 1
          fi
          
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Scan SSH host keys with retry (5 attempts for GitHub runner stability)
          echo "ğŸ” Scanning SSH host keys for ${{ secrets.VPS_SSH_HOST }}..."
          for i in {1..5}; do
            if ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts 2>/tmp/ssh-scan-err; then
              echo "âœ… SSH host keys retrieved (attempt $i/5)"
              break
            else
              echo "âš ï¸ Attempt $i/5 failed:"
              cat /tmp/ssh-scan-err || true
              if [ $i -eq 5 ]; then
                echo "âŒ Cannot reach SSH host after 5 attempts"
                echo "Check: VPS firewall, SSH port 22, VPS_SSH_HOST secret"
                exit 1
              fi
              sleep 3
            fi
          done

      - name: ğŸ”’ Hardening logs (anti-leak)
        run: |
          set -euo pipefail
          echo "::add-mask::${{ secrets.AWS_ACCESS_KEY_ID }}"
          echo "::add-mask::${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          echo "::add-mask::${{ secrets.AWS_S3_BUCKET }}"
          echo "::add-mask::${{ secrets.AWS_REGION }}"
          echo "::add-mask::${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          echo "::add-mask::${{ secrets.AZURE_STORAGE_KEY }}"
          echo "::add-mask::${{ secrets.AZURE_CONTAINER }}"
          echo "::add-mask::${{ secrets.GCS_BUCKET }}"
          echo "::add-mask::${{ secrets.B2_APPLICATION_KEY_ID }}"
          echo "::add-mask::${{ secrets.B2_APPLICATION_KEY }}"
          echo "::add-mask::${{ secrets.B2_BUCKET_NAME }}"
          echo "::add-mask::${{ secrets.SLACK_WEBHOOK_URL }}"
          echo "::add-mask::${{ secrets.DISCORD_WEBHOOK_URL }}"
          echo "::add-mask::${{ secrets.VPS_SSH_USER }}"
          echo "::add-mask::${{ secrets.VPS_SSH_HOST }}"
          echo "::add-mask::${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"

      - name: ğŸ’¾ Run Cloud Backup (hardened env-file)
        env:
          PROVIDER: ${{ env.PROVIDER }}

          # AWS S3
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

          # Azure (optional)
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
          AZURE_CONTAINER: ${{ secrets.AZURE_CONTAINER }}

          # GCS (optional)
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}

          # Backblaze B2 (optional)
          B2_APPLICATION_KEY_ID: ${{ secrets.B2_APPLICATION_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
          B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}

          # Notifications
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          echo "ğŸš€ Starting backup for production..."
          echo "Provider: ${PROVIDER:-auto-detect all configured}"

          # Create env file locally (restricted perms)
          umask 077
          cat > backup.env <<EOF
          PROVIDER=${PROVIDER}
          AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
          AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
          AWS_S3_BUCKET=${AWS_S3_BUCKET}
          AWS_REGION=${AWS_REGION}
          AZURE_STORAGE_ACCOUNT=${AZURE_STORAGE_ACCOUNT}
          AZURE_STORAGE_KEY=${AZURE_STORAGE_KEY}
          AZURE_CONTAINER=${AZURE_CONTAINER}
          GCS_BUCKET=${GCS_BUCKET}
          B2_APPLICATION_KEY_ID=${B2_APPLICATION_KEY_ID}
          B2_APPLICATION_KEY=${B2_APPLICATION_KEY}
          B2_BUCKET_NAME=${B2_BUCKET_NAME}
          SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
          DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
          EOF

          chmod 600 backup.env

          # Copy script + env to VPS
          scp -i ~/.ssh/deploy_key backup.env \
            "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}:/tmp/backup.env"

          scp -i ~/.ssh/deploy_key scripts/backup-to-cloud.sh \
            "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}:/tmp/backup-to-cloud.sh"

          # Run on VPS (no xtrace, strict mode)
          ssh -i ~/.ssh/deploy_key -o LogLevel=ERROR "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}" \
            "bash -lc 'set -euo pipefail;
              chmod 600 /tmp/backup.env;
              chmod 700 /tmp/backup-to-cloud.sh;
              set -a; . /tmp/backup.env; set +a;
              /tmp/backup-to-cloud.sh production \"\${PROVIDER}\";
              rm -f /tmp/backup-to-cloud.sh /tmp/backup.env'"

          # Local cleanup
          rm -f backup.env

      - name: âœ… Backup Success
        if: success()
        run: |
          echo "âœ… Production backup completed successfully!"
          echo "Environment: production"
          echo "Provider: ${{ env.PROVIDER || 'all configured providers' }}"
          echo "Timestamp: $(date)"

      - name: âŒ Backup Failed
        if: failure()
        run: |
          echo "âŒ Production backup failed!"
          exit 1

  backup-staging:
    needs: security
    name: ğŸ’¾ Backup Staging to Cloud
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'staging'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH
        run: |
          set -euo pipefail
          
          # Validate secrets
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ VPS_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_HOST }}" ]; then
            echo "âŒ VPS_SSH_HOST secret is not set"
            exit 1
          fi
          
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Scan SSH host keys with retry (5 attempts for GitHub runner stability)
          echo "ğŸ” Scanning SSH host keys for ${{ secrets.VPS_SSH_HOST }}..."
          for i in {1..5}; do
            if ssh-keyscan -H "${{ secrets.VPS_SSH_HOST }}" >> ~/.ssh/known_hosts 2>/tmp/ssh-scan-err; then
              echo "âœ… SSH host keys retrieved (attempt $i/5)"
              break
            else
              echo "âš ï¸ Attempt $i/5 failed:"
              cat /tmp/ssh-scan-err || true
              if [ $i -eq 5 ]; then
                echo "âŒ Cannot reach SSH host after 5 attempts"
                echo "Check: VPS firewall, SSH port 22, VPS_SSH_HOST secret"
                exit 1
              fi
              sleep 3
            fi
          done

      - name: ğŸ”’ Hardening logs (anti-leak)
        run: |
          set -euo pipefail
          echo "::add-mask::${{ secrets.AWS_ACCESS_KEY_ID }}"
          echo "::add-mask::${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          echo "::add-mask::${{ secrets.AWS_S3_BUCKET }}"
          echo "::add-mask::${{ secrets.AWS_REGION }}"
          echo "::add-mask::${{ secrets.VPS_SSH_USER }}"
          echo "::add-mask::${{ secrets.VPS_SSH_HOST }}"
          echo "::add-mask::${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}"

      - name: ğŸ’¾ Run Cloud Backup (hardened env-file)
        env:
          PROVIDER: ${{ env.PROVIDER }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
        run: |
          set -euo pipefail
          echo "ğŸš€ Starting backup for staging..."
          echo "Provider: ${PROVIDER:-auto-detect all configured}"

          umask 077
          cat > backup.env <<EOF
          PROVIDER=${PROVIDER}
          AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
          AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
          AWS_S3_BUCKET=${AWS_S3_BUCKET}
          AWS_REGION=${AWS_REGION}
          EOF

          chmod 600 backup.env

          scp -i ~/.ssh/deploy_key backup.env \
            "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}:/tmp/backup.env"

          scp -i ~/.ssh/deploy_key scripts/backup-to-cloud.sh \
            "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}:/tmp/backup-to-cloud.sh"

          ssh -i ~/.ssh/deploy_key -o LogLevel=ERROR "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SSH_HOST }}" \
            "bash -lc 'set -euo pipefail;
              chmod 600 /tmp/backup.env;
              chmod 700 /tmp/backup-to-cloud.sh;
              set -a; . /tmp/backup.env; set +a;
              /tmp/backup-to-cloud.sh staging \"\${PROVIDER}\";
              rm -f /tmp/backup-to-cloud.sh /tmp/backup.env'"

          rm -f backup.env

      - name: âœ… Backup Success
        if: success()
        run: |
          echo "âœ… Staging backup completed successfully!"

  notify:
    needs: [security, backup-production, backup-staging]
    name: ğŸ“¢ Notify Backup Status
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check Status
        run: |
          echo "Security:   ${{ needs.security.result }}"
          echo "Production: ${{ needs.backup-production.result }}"
          echo "Staging:    ${{ needs.backup-staging.result }}"

          if [ "${{ needs.backup-production.result }}" = "success" ] || [ "${{ needs.backup-staging.result }}" = "success" ]; then
            echo "âœ… Backup job(s) completed successfully"
          else
            echo "âŒ Some backup job(s) failed"
            exit 1
          fi
