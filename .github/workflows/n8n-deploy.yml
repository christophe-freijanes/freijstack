name: ğŸ¤– n8n Automation

on:
  push:
    branches: [develop, master]
    paths:
      - 'saas/n8n/**'
      - '.github/workflows/n8n-deploy.yml'
  pull_request:
    branches: [develop, master]
    paths:
      - 'saas/n8n/**'
      - '.github/workflows/n8n-deploy.yml'
  workflow_dispatch:

jobs:
  validate:
    name: ğŸ” Validate n8n Configuration
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“„ Check README documentation
        working-directory: saas/n8n
        run: |
          if [ -f "README.md" ]; then
            echo "âœ… n8n README.md found"
            wc -l README.md
          else
            echo "âŒ n8n README.md missing!"
            exit 1
          fi

      - name: ğŸ§ª Validate n8n image exists
        run: |
          docker pull docker.n8n.io/n8nio/n8n:latest
          echo "âœ… n8n image validated"

  security:
    name: ğŸ” Security Checks
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'docker.n8n.io/n8nio/n8n:latest'
          format: 'sarif'
          output: 'trivy-n8n.sarif'
        continue-on-error: true

      - name: ğŸ“¤ Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-*.sarif'
        continue-on-error: true

  documentation:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“– Validate documentation completeness
        working-directory: saas/n8n
        run: |
          echo "Checking n8n README.md structure..."
          
          # Check for required sections
          grep -q "# " README.md && echo "âœ… Title present"
          grep -q "## " README.md && echo "âœ… Sections present"
          grep -q "## ğŸ¯ FonctionnalitÃ©s\|## ğŸ—ï¸ Architecture\|## ğŸš€" README.md && echo "âœ… Main sections found"
          
          echo "âœ… Documentation structure validated"

      - name: ğŸ”— Check links in README
        working-directory: saas
        run: |
          echo "Checking n8n/README.md links..."
          grep -o '\[.*\](.*\.md)' n8n/README.md || echo "No markdown links found"
          echo "âœ… Link check completed"

  notify:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    if: always()
    needs: [validate, security, documentation]

    steps:
      - name: âœ… Validation Success
        if: success()
        run: |
          echo "âœ… n8n validation passed!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: âŒ Validation Failed
        if: failure()
        run: |
          echo "âŒ n8n validation failed!"
          exit 1
