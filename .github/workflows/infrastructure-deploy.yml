name: ğŸ—ï¸ Infrastructure

on:
  push:
    branches: [develop, master]
    paths:
      - 'base-infra/**'
      - '.github/workflows/infrastructure-deploy.yml'
  pull_request:
    branches: [develop, master]
    paths:
      - 'base-infra/**'
      - '.github/workflows/infrastructure-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      deploy_traefik:
        description: 'DÃ©ployer Traefik'
        required: false
        default: true
        type: boolean
      deploy_portfolio:
        description: 'DÃ©ployer Portfolio'
        required: false
        default: true
        type: boolean
      deploy_n8n:
        description: 'DÃ©ployer n8n'
        required: false
        default: true
        type: boolean

env:
  # Paths
  PROJECT_PATH: base-infra
  COMPOSE_FILE: docker-compose.yml
  # Branches
  BRANCH_PROD: master
  BRANCH_STAGING: develop
  # Docker images
  TRAEFIK_IMAGE: traefik:latest
  # Services
  SERVICE_TRAEFIK: traefik
  SERVICE_PORTFOLIO: portfolio
  SERVICE_N8N: n8n

jobs:
  validate:
    name: ğŸ” Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Validate Docker Compose syntax
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          docker compose config > /dev/null
          echo "âœ… ${{ env.COMPOSE_FILE }} syntax valid"

      - name: ğŸ” Check environment variables (safe)
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          echo "Checking Docker Compose env placeholders (without values)..."
          # Validate compose parses and contains no obvious unresolved variables
          docker compose config > /dev/null
          echo "âœ… Docker Compose configuration validated without exposing env values"

  security:
    name: ğŸ” Security Checks
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: ${{ env.PROJECT_PATH }}
          format: 'sarif'
          output: 'trivy-base-infra.sarif'
        continue-on-error: true

      - name: ğŸ“¤ Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-*.sarif'
        continue-on-error: true

      - name: ğŸ” Gitleaks secret detection
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true

  test:
    name: âœ… Test Configuration
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Build Docker images (test)
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          echo "Testing ${{ env.SERVICE_TRAEFIK }} image..."
          docker pull ${{ env.TRAEFIK_IMAGE }}
          
          echo "âœ… ${{ env.SERVICE_TRAEFIK }} image validated"

      - name: ğŸ§ª Validate docker-compose services
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          docker compose config --format json | jq .services | grep -E "${{ env.SERVICE_TRAEFIK }}"
          echo "âœ… ${{ env.SERVICE_TRAEFIK }} service configured"

  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    if: always()
    needs: [validate, security, test]

    steps:
      - name: âœ… Validation Success
        if: success()
        run: |
          echo "âœ… Infrastructure validation passed!"
          echo "Environment: ${{ github.ref == format('refs/heads/{0}', env.BRANCH_PROD) && 'production' || 'staging' }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: âŒ Validation Failed
        if: failure()
        run: |
          echo "âŒ Infrastructure validation failed!"
          exit 1
