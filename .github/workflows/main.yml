name: CI/CD - FreijStack

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  IS_PRODUCTION: ${{ github.ref == 'refs/heads/master' }}
  IS_STAGING: ${{ github.ref == 'refs/heads/develop' }}

jobs:
  # Job 1: Validation et Linting
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Lint HTML
        run: |
          npm install -g html-validate
          html-validate portfolio/index.html || true

      - name: Validate CSS
        run: |
          npm install -g stylelint stylelint-config-standard
          stylelint "portfolio/style.css" || true

      - name: Check JavaScript
        run: |
          npm install -g eslint
          eslint portfolio/script.js || true

      - name: Security audit
        run: npm audit --audit-level=moderate || true

  # Job 2: Build & Optimize Assets
  build:
    name: Build & Optimize
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Minify CSS
        run: |
          npm install -g csso-cli
          csso portfolio/style.css -o portfolio/style.min.css
          echo "‚úÖ CSS minified"

      - name: Minify JavaScript
        run: |
          npm install -g terser
          terser portfolio/script.js -o portfolio/script.min.js -c -m
          echo "‚úÖ JavaScript minified"

      - name: Optimize assets
        run: |
          echo "Asset sizes before optimization:"
          ls -lh portfolio/*.{css,js} | awk '{print $9, $5}'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: portfolio/
          retention-days: 5

  # Job 3: Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for hardcoded secrets
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ github.token }}

  # Job 4: Deploy to GitHub Pages (Staging - develop)
  deploy-pages-staging:
    name: Deploy to GitHub Pages (Staging)
    runs-on: ubuntu-latest
    needs: [validate, build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages-staging
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        continue-on-error: true
        uses: actions/configure-pages@v4

      - name: Build static site
        run: |
          mkdir -p _site/portfolio
          cp -r portfolio/* _site/portfolio/
          echo "<!-- STAGING ENVIRONMENT -->" >> _site/portfolio/index.html
          echo "‚úÖ Staging site built"

      - name: Upload artifact
        continue-on-error: true
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        continue-on-error: true
        uses: actions/deploy-pages@v4

  # Job 5: Deploy to Hostinger (Staging - develop)
  deploy-hostinger-staging:
    name: Deploy to Hostinger (Staging)
    runs-on: ubuntu-latest
    needs: [validate, build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOSTINGER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HOSTINGER_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create staging directory on VPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }} \
            'mkdir -p /srv/www/portfolio-staging && echo "üìÅ Staging directory ready"'

      - name: Backup existing staging (if exists)
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }} \
            'if [ -d /srv/www/portfolio-staging ] && [ "$(ls -A /srv/www/portfolio-staging)" ]; then \
               cp -r /srv/www/portfolio-staging /srv/www/portfolio-staging.backup.$(date +%s); \
               echo "üíæ Backup created"; \
             fi'

      - name: Deploy portfolio to staging (/portfolio-staging)
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
            portfolio/ ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }}:/srv/www/portfolio-staging/

      - name: Verify staging deployment
        run: |
          echo "‚úÖ Portfolio d√©ploy√© vers STAGING!"
          echo "üìç Path: /srv/www/portfolio-staging"
          ssh -i ~/.ssh/deploy_key ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }} \
            'ls -lh /srv/www/portfolio-staging/ | head -10'

  # Job 6: Deploy to Hostinger (Production - master)
  deploy-hostinger:
    name: Deploy to Hostinger (Production)
    runs-on: ubuntu-latest
    needs: [validate, build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOSTINGER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HOSTINGER_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create production directory on VPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }} \
            'mkdir -p /srv/www/portfolio && echo "üìÅ Production directory ready"'

      - name: Backup existing production (if exists)
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }} \
            'if [ -d /srv/www/portfolio ] && [ "$(ls -A /srv/www/portfolio)" ]; then \
               cp -r /srv/www/portfolio /srv/www/portfolio.backup.$(date +%s); \
               echo "üíæ Backup created"; \
             fi'

      - name: Deploy portfolio to production (/portfolio)
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
            portfolio/ ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }}:/srv/www/portfolio/

      - name: Verify production deployment
        run: |
          echo "‚úÖ Portfolio d√©ploy√© vers PRODUCTION!"
          echo "üìç Production: https://${{ secrets.HOSTINGER_DOMAIN }}/portfolio/"
          echo "üìç GitHub Pages: https://${{ github.repository_owner }}.github.io/freijstack/portfolio"
          ssh -i ~/.ssh/deploy_key ${{ secrets.HOSTINGER_SSH_USER }}@${{ secrets.HOSTINGER_SSH_HOST }} \
            'ls -lh /srv/www/portfolio/ | head -10'

  # Job 7: Notifications
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [validate, build, security, deploy-pages-staging, deploy-hostinger, deploy-hostinger-staging]
    if: always()
    
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "üß™ STAGING Environment"
            if [ "${{ needs.deploy-pages-staging.result }}" == "success" ] || [ "${{ needs.deploy-hostinger-staging.result }}" == "success" ]; then
              echo "‚úÖ Staging deployment successful!"
              echo "üìç Test your changes before merging to main"
            else
              echo "‚ö†Ô∏è Staging deployment had issues. Check the logs above."
            fi
          elif [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "üöÄ PRODUCTION Environment"
            if [ "${{ needs.deploy-hostinger.result }}" == "success" ]; then
              echo "‚úÖ Production deployment successful (VPS)."
              echo "üéØ Portfolio is live on VPS. GitHub Pages prod d√©sactiv√©."
            else
              echo "‚ö†Ô∏è Production deployment had issues. Check the logs above."
            fi
          fi

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## FreijStack Release
            Deployment completed successfully!
            - Portfolio: Live on GitHub Pages & Hostinger
            - Security: All checks passed
            - Performance: Assets optimized
          draft: false
          prerelease: false

      # Les applications SaaS n√©cessiteront probablement des √©tapes de build Docker et un d√©ploiement plus complexe.
      # Ces √©tapes seront ajout√©es ult√©rieurement ou dans des workflows d√©di√©s pour chaque application SaaS.
      # Restez √† l'√©coute pour les futures mises √† jour !
