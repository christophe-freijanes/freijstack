name: CI/CD - FreijStack

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  IS_PRODUCTION: ${{ github.ref == 'refs/heads/master' }}
  IS_STAGING: ${{ github.ref == 'refs/heads/develop' }}

jobs:
  # Job 1: Validation et Linting
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint HTML
        run: |
          npm install -g html-validate
          html-validate portfolio/index.html || true

      - name: Validate CSS
        run: |
          npm install -g stylelint stylelint-config-standard
          stylelint "portfolio/style.css" || true

      - name: Check JavaScript
        run: |
          npm install -g eslint
          eslint portfolio/script.js || true

      - name: Security audit
        run: npm audit --audit-level=moderate || true

  # Job 2: Build & Optimize Assets
  build:
    name: Build & Optimize
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Minify CSS
        run: |
          npm install -g csso-cli
          csso portfolio/style.css -o portfolio/style.min.css
          echo "‚úÖ CSS minified"

      - name: Minify JavaScript
        run: |
          npm install -g terser
          terser portfolio/script.js -o portfolio/script.min.js -c -m
          echo "‚úÖ JavaScript minified"

      - name: Optimize assets
        run: |
          echo "Asset sizes before optimization:"
          ls -lh portfolio/*.{css,js} | awk '{print $9, $5}'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: portfolio/
          retention-days: 5

  # Job 3: Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for hardcoded secrets
        uses: gitleaks/gitleaks-action@v2

  # Job 4: Deploy to GitHub Pages (Staging - develop)
  deploy-pages-staging:
    name: Deploy to GitHub Pages (Staging)
    runs-on: ubuntu-latest
    needs: [validate, build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages-staging
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build static site
        run: |
          mkdir -p _site/portfolio
          cp -r portfolio/* _site/portfolio/
          echo "<!-- STAGING ENVIRONMENT -->" >> _site/portfolio/index.html
          echo "‚úÖ Staging site built"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job 5: Deploy to GitHub Pages (Production - main)
  deploy-pages:
    name: Deploy to GitHub Pages (Production)
    runs-on: ubuntu-latest
    needs: [validate, build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build static site
        run: |
          mkdir -p _site/portfolio
          cp -r portfolio/* _site/portfolio/
          echo "‚úÖ Static site built"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job 6: Deploy to Hostinger (Staging - develop)
  deploy-hostinger-staging:
    name: Deploy to Hostinger (Staging)
    runs-on: ubuntu-latest
    needs: [validate, build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SFTP to Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOSTINGER_SSH_HOST }}
          username: ${{ secrets.HOSTINGER_SSH_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          script: |
            echo "üöÄ Starting deployment to Hostinger STAGING..."
            
            # Backup current version
            if [ -d ~/public_html/staging/portfolio ]; then
              cp -r ~/public_html/staging/portfolio ~/public_html/staging/portfolio.backup.$(date +%s)
            fi
            
            # Create destination
            mkdir -p ~/public_html/staging/portfolio
            
            # Sync new files
            rsync -avz --delete ./portfolio/ ~/public_html/staging/portfolio/
            
            echo "‚úÖ Staging deployment completed"
            ls -lh ~/public_html/staging/portfolio/

      - name: Verify staging deployment
        run: |
          echo "‚úÖ Portfolio deployed to STAGING!"
          echo "üìç Staging URL: ${{ secrets.HOSTINGER_DOMAIN }}/staging/portfolio"

  # Job 7: Deploy to Hostinger (Production - main)
  deploy-hostinger:
    name: Deploy to Hostinger (Production)
    runs-on: ubuntu-latest
    needs: [validate, build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SFTP
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOSTINGER_SSH_HOST }}
          username: ${{ secrets.HOSTINGER_SSH_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          script: |
            echo "üöÄ Starting deployment to Hostinger..."
            
            # Backup current version
            if [ -d ~/public_html/portfolio ]; then
              cp -r ~/public_html/portfolio ~/public_html/portfolio.backup.$(date +%s)
            fi
            
            # Create destination
            mkdir -p ~/public_html/portfolio
            
            # Sync new files
            rsync -avz --delete ./portfolio/ ~/public_html/portfolio/
            
            echo "‚úÖ Deployment completed"
            ls -lh ~/public_html/portfolio/

      - name: Verify deployment
        run: |
          echo "‚úÖ Portfolio deployed successfully!"
          echo "üìç GitHub Pages: https://${{ github.repository_owner }}.github.io/freijstack/portfolio"
          echo "üìç Hostinger: ${{ secrets.HOSTINGER_DOmaster }}/portfolio"

  # Job 8: Notifications
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [validate, build, security, deploy-pages, deploy-pages-staging, deploy-hostinger, deploy-hostinger-staging]
    if: always()
    
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "üß™ STAGING Environment"
            if [ "${{ needs.deploy-pages-staging.result }}" == "success" ] || [ "${{ needs.deploy-hostinger-staging.result }}" == "success" ]; then
              echo "‚úÖ Staging deployment successful!"
              echo "üìç Test your changes before merging to main"
            else
              echo "‚ö†Ô∏è Staging deployment had issues. Check the logs above."
            fi
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "üöÄ PRODUCTION Environment"
            if [ "${{ needs.deploy-pages.result }}" == "success" ] || [ "${{ needs.deploy-hostinger.result }}" == "success" ]; then
              echo "‚úÖ Production deployment successful!"
              echo "üéØ Portfolio is live and ready to showcase your DevSecOps skills!"
            else
              echo "‚ö†Ô∏è Production deployment had issues. Check the logs above."
            fi
          fi

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## FreijStack Release
            Deployment completed successfully!
            - Portfolio: Live on GitHub Pages & Hostinger
            - Security: All checks passed
            - Performance: Assets optimized
          draft: false
          prerelease: false

      # Les applications SaaS n√©cessiteront probablement des √©tapes de build Docker et un d√©ploiement plus complexe.
      # Ces √©tapes seront ajout√©es ult√©rieurement ou dans des workflows d√©di√©s pour chaque application SaaS.
