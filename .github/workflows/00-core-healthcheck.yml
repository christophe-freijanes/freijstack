name: ðŸ§© Core â€¢ Healthcheck

on:
  workflow_call:
    inputs:
      warmup_url:
        description: "URL used for warm-up probing (frontend or /v2/)"
        required: true
        type: string
      checks:
        description: |
          Multi-line checks:
          url|allowed_codes_csv|label
          Example:
          https://vault.freijstack.com/|200,301,302|Vault FE
        required: true
        type: string
      max_wait_seconds:
        required: false
        type: number
        default: 90
      warmup_interval_seconds:
        required: false
        type: number
        default: 5
      max_retries:
        required: false
        type: number
        default: 8
      sleep_between_retries:
        required: false
        type: number
        default: 10

permissions:
  contents: read
  actions: read

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: â³ Warm-up probe
        run: |
          set -euo pipefail

          MAX_WAIT="${{ inputs.max_wait_seconds }}"
          INTERVAL="${{ inputs.warmup_interval_seconds }}"
          PROBE_URL="${{ inputs.warmup_url }}"

          echo "ðŸ” Probing: $PROBE_URL"
          echo "â³ Max wait: ${MAX_WAIT}s (interval: ${INTERVAL}s)"

          start_time=$(date +%s)

          for _ in $(seq 1 $((MAX_WAIT / INTERVAL))); do
            elapsed=$(( $(date +%s) - start_time ))

            code=$(curl -sL -o /dev/null -w "%{http_code}" \
              --connect-timeout 5 \
              --max-time 10 \
              "$PROBE_URL" || echo "000")

            case "$code" in
              2*|3*|401)
                echo "âœ… Service ready after ${elapsed}s (HTTP $code)"
                echo "## ðŸ©º Health Check" >> "$GITHUB_STEP_SUMMARY"
                echo "" >> "$GITHUB_STEP_SUMMARY"
                echo "- Warm-up: **${elapsed}s** (HTTP $code)" >> "$GITHUB_STEP_SUMMARY"
                exit 0
                ;;
              *)
                echo "â³ Waiting... ${elapsed}s (HTTP $code)"
                sleep "$INTERVAL"
                ;;
            esac
          done

          echo "âš ï¸ Timeout after ${MAX_WAIT}s - proceeding anyway"
          echo "## ðŸ©º Health Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Warm-up: **timeout (${MAX_WAIT}s)** - proceeding anyway" >> "$GITHUB_STEP_SUMMARY"

      - name: ðŸŒ Run checks (with retries)
        run: |
          set -euo pipefail

          MAX_RETRIES="${{ inputs.max_retries }}"
          SLEEP_BETWEEN="${{ inputs.sleep_between_retries }}"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ðŸŒ URL checks" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Parse multi-line checks
          # Format per line: url|allowed_codes_csv|label
          while IFS= read -r line; do
            [ -z "$line" ] && continue

            url="${line%%|*}"
            rest="${line#*|}"
            allowed="${rest%%|*}"
            label="${rest##*|}"

            echo ""
            echo "ðŸ”Ž Checking $label â†’ $url"

            attempt=1
            success=false
            last_code="000"

            while [ "$attempt" -le "$MAX_RETRIES" ]; do
              code=$(curl -sL -o /dev/null -w "%{http_code}" \
                --connect-timeout 10 \
                --max-time 20 \
                "$url" || echo "000")

              last_code="$code"

              if echo ",$allowed," | grep -q ",$code,"; then
                echo "âœ… OK (HTTP $code)"
                echo "- âœ… **$label**: HTTP $code (attempt $attempt/$MAX_RETRIES)" >> "$GITHUB_STEP_SUMMARY"
                success=true
                break
              fi

              echo "âš ï¸ HTTP $code (attempt $attempt/$MAX_RETRIES)"
              if [ "$attempt" -lt "$MAX_RETRIES" ]; then
                sleep "$SLEEP_BETWEEN"
              fi
              attempt=$((attempt + 1))
            done

            if [ "$success" != "true" ]; then
              echo "âŒ $label is DOWN after $MAX_RETRIES attempts"
              echo "- âŒ **$label**: FAILED after $MAX_RETRIES attempts (last HTTP $last_code)" >> "$GITHUB_STEP_SUMMARY"
              exit 1
            fi
          done <<< "${{ inputs.checks }}"

      - name: âœ… Done
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… **All checks passed**" >> "$GITHUB_STEP_SUMMARY"
