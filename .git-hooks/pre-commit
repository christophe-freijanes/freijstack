#!/bin/bash
# üîí Pre-commit Hook - Security Check
# Ex√©cut√© automatiquement avant chaque commit
# Installation: cp .git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîí Pre-commit Security Check${NC}"
echo "================================"

ERRORS=0

# 1. Check for .env files
if git diff --cached --name-only | grep -E "\.env[^.]" > /dev/null; then
    echo -e "${RED}‚ùå Ne commiter pas .env!${NC}"
    echo "   Utiliser .env.example √† la place"
    ERRORS=$((ERRORS + 1))
fi

# 2. Check for private keys
if git diff --cached --name-only | grep -E "\.key|\.pem|id_rsa|id_ed25519|\.p12|\.pfx" > /dev/null; then
    echo -e "${RED}‚ùå Cl√©s priv√©es d√©tect√©es!${NC}"
    ERRORS=$((ERRORS + 1))
fi

# 3. Check for credentials
if git diff --cached --name-only | grep -E "credentials\.json|secret" > /dev/null; then
    echo -e "${RED}‚ùå Fichiers credentials d√©tect√©s!${NC}"
    ERRORS=$((ERRORS + 1))
fi

# 4. Check for database files
if git diff --cached --name-only | grep -E "\.db|\.sqlite|pgdata|mongodata" > /dev/null; then
    echo -e "${RED}‚ùå Fichiers bases de donn√©es d√©tect√©s!${NC}"
    ERRORS=$((ERRORS + 1))
fi

# 5. Look for common secrets patterns in staged code
STAGED_CODE=$(git diff --cached --unified=0 | grep "^\+[^+]" || true)
if echo "$STAGED_CODE" | grep -iE "(password|secret|api.?key|token|auth)" | grep -v ".env.example" | grep -v "^+++" > /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Possibles secrets d√©tect√©s - v√©rifiez manuellement${NC}"
    echo "$STAGED_CODE" | grep -iE "(password|secret|api.?key|token|auth)" || true
fi

# 6. Check for console.log in JavaScript
if git diff --cached --unified=0 -- "*.js" "*.ts" | grep "^\+[^+]" | grep -E "console\.(log|error|warn|debug)" > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  console.log d√©tect√© dans le code${NC}"
fi

# 7. Summary
echo "================================"
if [ "$ERRORS" -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Security check passed!${NC}"
    exit 0
else
    echo -e "${RED}‚ùå S√©curit√©: $ERRORS erreur(s)${NC}"
    echo "   Utilisez: git commit --no-verify (avec prudence!)"
    exit 1
fi
