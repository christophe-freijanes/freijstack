%%{init: {'theme':'dark', 'themeVariables': { 'fontSize':'14px'}}}%%
graph TB
    %% Sources
    DEV["ğŸ‘¨â€ğŸ’» DÃ©veloppeur"]
    GITHUB["ğŸ“¦ GitHub Repository"]
    
    %% Branches
    DEVELOP["ğŸŒ¿ Branch: develop<br/>(staging)"]
    MASTER["ğŸŒ¿ Branch: master<br/>(production)"]
    PR["ğŸ”€ Pull Request"]
    
    %% CI Workflows
    PR_CHECK["âœ… PR Title Automation<br/>Conventional Commits"]
    CODEQL["ğŸ•µï¸ CodeQL Analysis<br/>JavaScript/TypeScript/Python"]
    SECURITY["ğŸ›¡ï¸ Security Check<br/>Trivy + Gitleaks"]
    SECURITY_SCORE["ğŸ“Š Security Score<br/>JSON Badge"]
    
    %% Build & Deploy
    INFRA_DEPLOY["ğŸ—ï¸ Infrastructure Deploy<br/>Traefik + n8n"]
    PORTFOLIO_DEPLOY["ğŸŒ Portfolio Deploy<br/>HTML/CSS/JS"]
    VAULT_DEPLOY["ğŸ” SecureVault Deploy<br/>Node.js + React + PostgreSQL"]
    HARBOR_DEPLOY["âš“ Harbor Deploy<br/>Docker Registry"]
    
    %% Post-Deploy
    HEALTHCHECK_POST["ğŸ¥ Health Check Post-Deploy<br/>Smart Cooldown (5-90s)<br/>Master only"]
    HEALTHCHECK_PROD["ğŸ¥ Health Check Prod<br/>Every 30min â€¢ Curl v1.2<br/>10s connect, 30s max<br/>502/503/000 warm-up detect"]
    HEALTHCHECK_DEV["ğŸ¥ Health Check Dev<br/>Every hour â€¢ Curl v1.2<br/>10s connect, 30s max<br/>502/503/000 warm-up detect"]
    
    %% Releases
    RELEASE_PR["ğŸ“ Release Changelog PR<br/>semantic-release --dry-run"]
    RELEASE_AUTO["ğŸš€ Release Automation<br/>semantic-release + tag"]
    
    %% Maintenance
    BACKUP["ğŸ’¾ Backup to Cloud<br/>PostgreSQL + Config"]
    ROTATE["ğŸ”„ Rotate Secrets<br/>JWT + DB Passwords"]
    
    %% Environments
    VPS_STAGING["ğŸ–¥ï¸ VPS Staging<br/>Docker Compose"]
    VPS_PROD["ğŸ–¥ï¸ VPS Production<br/>Docker Compose"]
    
    %% Cloud
    S3["â˜ï¸ AWS S3<br/>Backup Storage"]
    AZURE["â˜ï¸ Azure Blob<br/>Backup Storage"]
    PAGES["ğŸ“„ GitHub Pages<br/>Security Badge"]
    
    %% Notifications
    DISCORD["ğŸ“§ Discord Webhook<br/>Notifications"]
    
    %% Developer Flow
    DEV -->|git push develop| DEVELOP
    DEV -->|git push master| MASTER
    DEV -->|create PR| PR
    
    DEVELOP --> GITHUB
    MASTER --> GITHUB
    PR --> GITHUB
    
    %% PR Checks
    PR -->|on open/edit| PR_CHECK
    PR -->|trigger| CODEQL
    PR_CHECK -->|status check| GITHUB
    CODEQL -->|results| GITHUB
    
    %% Security Scheduled
    GITHUB -.->|cron: daily 04:00| SECURITY
    GITHUB -.->|cron: weekly| CODEQL
    SECURITY -->|publish| SECURITY_SCORE
    SECURITY_SCORE -->|upload| PAGES
    SECURITY -->|if leaks found| DISCORD
    
    %% Deploy from develop
    DEVELOP -->|push trigger| INFRA_DEPLOY
    DEVELOP -->|push trigger| PORTFOLIO_DEPLOY
    DEVELOP -->|push trigger| VAULT_DEPLOY
    DEVELOP -->|push trigger| HARBOR_DEPLOY
    
    INFRA_DEPLOY -->|docker-compose up| VPS_STAGING
    PORTFOLIO_DEPLOY -->|rsync + nginx reload| VPS_STAGING
    VAULT_DEPLOY -->|docker-compose + migrations| VPS_STAGING
    HARBOR_DEPLOY -->|docker-compose| VPS_STAGING
    
    %% Deploy from master
    MASTER -->|push trigger| INFRA_DEPLOY
    MASTER -->|push trigger| PORTFOLIO_DEPLOY
    MASTER -->|push trigger| VAULT_DEPLOY
    MASTER -->|push trigger| HARBOR_DEPLOY
    
    INFRA_DEPLOY -->|docker-compose up| VPS_PROD
    PORTFOLIO_DEPLOY -->|rsync + nginx reload| VPS_PROD
    VAULT_DEPLOY -->|docker-compose + migrations| VPS_PROD
    HARBOR_DEPLOY -->|docker-compose| VPS_PROD
    
    %% Post-Deploy Checks (master only)
    PORTFOLIO_DEPLOY -->|workflow_run: success + master| HEALTHCHECK_POST
    VAULT_DEPLOY -->|workflow_run: success + master| HEALTHCHECK_POST
    HARBOR_DEPLOY -->|workflow_run: success + master| HEALTHCHECK_POST
    INFRA_DEPLOY -->|workflow_run: success + master| HEALTHCHECK_POST
    
    %% Continuous Monitoring
    VPS_PROD -.->|cron: */30 min| HEALTHCHECK_PROD
    VPS_STAGING -.->|cron: hourly| HEALTHCHECK_DEV
    
    HEALTHCHECK_PROD -->|if status >= 3| DISCORD
    HEALTHCHECK_DEV -->|if status >= 3| DISCORD
    
    HEALTHCHECK_PROD -->|auto-restart if 3x fail| VPS_PROD
    HEALTHCHECK_DEV -->|auto-restart if 3x fail| VPS_STAGING
    
    %% Release Flow
    MASTER -->|push trigger| RELEASE_PR
    RELEASE_PR -->|create PR| GITHUB
    GITHUB -->|merge PR| RELEASE_AUTO
    RELEASE_AUTO -->|create tag| GITHUB
    RELEASE_AUTO -->|publish release| GITHUB
    
    %% Maintenance Scheduled
    GITHUB -.->|cron: daily 03:00| BACKUP
    GITHUB -.->|cron: monthly 1st| ROTATE
    
    BACKUP -->|compress + encrypt| S3
    BACKUP -->|compress + encrypt| AZURE
    BACKUP -->|notify| DISCORD
    
    ROTATE -->|new secrets| VPS_PROD
    ROTATE -->|new secrets| VPS_STAGING
    ROTATE -->|summary email| DISCORD
    
    %% Styling
    classDef sourceNode fill:#1a1a2e,stroke:#16213e,stroke-width:2px,color:#fff
    classDef branchNode fill:#0f3460,stroke:#16213e,stroke-width:2px,color:#fff
    classDef prNode fill:#16213e,stroke:#0f3460,stroke-width:2px,color:#fff
    classDef secNode fill:#d32f2f,stroke:#9a0007,stroke-width:2px,color:#fff
    classDef deployNode fill:#533483,stroke:#6c4f9e,stroke-width:2px,color:#fff
    classDef healthNode fill:#f39c12,stroke:#c87f0a,stroke-width:2px,color:#fff
    classDef envNode fill:#e94560,stroke:#a83244,stroke-width:3px,color:#fff
    classDef cloudNode fill:#048ba8,stroke:#0a6e7f,stroke-width:2px,color:#fff
    classDef releaseNode fill:#27ae60,stroke:#1e8449,stroke-width:2px,color:#fff
    classDef notifyNode fill:#9b59b6,stroke:#6c3483,stroke-width:2px,color:#fff
    
    class DEV,GITHUB sourceNode
    class DEVELOP,MASTER branchNode
    class PR,PR_CHECK prNode
    class CODEQL,SECURITY,SECURITY_SCORE secNode
    class INFRA_DEPLOY,PORTFOLIO_DEPLOY,VAULT_DEPLOY,HARBOR_DEPLOY,BACKUP,ROTATE deployNode
    class HEALTHCHECK_POST,HEALTHCHECK_PROD,HEALTHCHECK_DEV healthNode
    class VPS_STAGING,VPS_PROD envNode
    class S3,AZURE,PAGES cloudNode
    class RELEASE_PR,RELEASE_AUTO releaseNode
    class DISCORD notifyNode
