version: '3.8'

services:
  # ============================================
  # PostgreSQL - Harbor Database
  # ============================================
  harbor-db:
    image: goharbor/harbor-db:v2.10.0
    container_name: ${CONTAINER_PREFIX}-db
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    volumes:
      - harbor-db:/var/lib/postgresql/data:z
    networks:
      - harbor
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Redis - Cache & Job Queue
  # ============================================
  harbor-redis:
    image: goharbor/redis-photon:v2.10.0
    container_name: ${CONTAINER_PREFIX}-redis
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - harbor-redis:/var/lib/redis
    networks:
      - harbor
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Harbor Core - API & Web UI
  # ============================================
  harbor-core:
    image: goharbor/harbor-core:v2.10.0
    container_name: ${CONTAINER_PREFIX}-core
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    depends_on:
      - harbor-db
      - harbor-redis
    volumes:
      - harbor-config:/etc/harbor:z
      - harbor-ca:/etc/harbor/ssl:z
      - harbor-psc:/etc/harbor/psc:z
    networks:
      - harbor
    environment:
      CORE_SECRET: ${CORE_SECRET}
      JOBSERVICE_SECRET: ${JOBSERVICE_SECRET}
      EXT_ENDPOINT: https://${REGISTRY_DOMAIN}
      DATABASE_TYPE: postgresql
      POSTGRESQL_HOST: harbor-db
      POSTGRESQL_PORT: 5432
      POSTGRESQL_USERNAME: postgres
      POSTGRESQL_PASSWORD: ${DB_PASSWORD}
      POSTGRESQL_DATABASE: registry
      POSTGRESQL_SSLMODE: disable
      POSTGRESQL_MAX_IDLE_CONNS: 100
      POSTGRESQL_MAX_OPEN_CONNS: 900
      REDIS_HOST: harbor-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      HARBOR_ADMIN_PASSWORD: ${HARBOR_ADMIN_PASSWORD}
      CORE_URL: http://harbor-core:8080
      JOBSERVICE_URL: http://harbor-jobservice:8080
      REGISTRY_URL: http://harbor-registry:5000
      TOKEN_SERVICE_URL: http://harbor-core:8080/service/token
      REGISTRY_CONTROLLER_URL: http://harbor-registryctl:8080
      PORTAL_URL: http://harbor-portal:8080
      LOG_LEVEL: info
      CONFIG_PATH: /etc/harbor
      CHART_CACHE_DRIVER: redis
      _REDIS_URL_CORE: redis://harbor-redis:6379/0
      _REDIS_URL_REG: redis://harbor-redis:6379/1
      TRIVY_ADAPTER_URL: http://harbor-trivy:8080
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/v2.0/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Harbor Portal - Web Interface
  # ============================================
  harbor-portal:
    image: goharbor/harbor-portal:v2.10.0
    container_name: ${CONTAINER_PREFIX}-portal
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
    networks:
      - harbor
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Harbor Registry - Docker Registry
  # ============================================
  harbor-registry:
    image: goharbor/registry-photon:v2.10.0
    container_name: ${CONTAINER_PREFIX}-registry
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - harbor-registry:/storage:z
      - harbor-config:/etc/registry:z
    networks:
      - harbor
    environment:
      REGISTRY_HTTP_SECRET: ${REGISTRY_HTTP_SECRET}
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 5000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Harbor Registry Controller
  # ============================================
  harbor-registryctl:
    image: goharbor/harbor-registryctl:v2.10.0
    container_name: ${CONTAINER_PREFIX}-registryctl
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - harbor-registry:/storage:z
      - harbor-config:/etc/registry:z
      - harbor-registryctl-config:/etc/registryctl:z
    networks:
      - harbor
    environment:
      CORE_SECRET: ${CORE_SECRET}
      JOBSERVICE_SECRET: ${JOBSERVICE_SECRET}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Harbor Job Service
  # ============================================
  harbor-jobservice:
    image: goharbor/harbor-jobservice:v2.10.0
    container_name: ${CONTAINER_PREFIX}-jobservice
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    depends_on:
      - harbor-core
    volumes:
      - harbor-jobservice:/var/log/jobs:z
      - harbor-config:/etc/harbor:z
    networks:
      - harbor
    environment:
      CORE_SECRET: ${CORE_SECRET}
      JOBSERVICE_SECRET: ${JOBSERVICE_SECRET}
      CORE_URL: http://harbor-core:8080
      REGISTRY_URL: http://harbor-registry:5000
      REGISTRY_CONTROLLER_URL: http://harbor-registryctl:8080
      LOG_LEVEL: info
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/v1/stats || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Trivy Adapter - Vulnerability Scanner
  # ============================================
  harbor-trivy:
    image: goharbor/trivy-adapter-photon:v2.10.0
    container_name: ${CONTAINER_PREFIX}-trivy
    restart: always
    cap_drop:
      - ALL
    volumes:
      - harbor-trivy:/home/scanner/.cache:z
    networks:
      - harbor
    environment:
      SCANNER_LOG_LEVEL: info
      SCANNER_TRIVY_CACHE_DIR: /home/scanner/.cache/trivy
      SCANNER_TRIVY_REPORTS_DIR: /home/scanner/.cache/reports
      SCANNER_TRIVY_DEBUG_MODE: "false"
      SCANNER_TRIVY_VULN_TYPE: "os,library"
      SCANNER_TRIVY_SEVERITY: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"
      SCANNER_TRIVY_IGNORE_UNFIXED: "false"
      SCANNER_TRIVY_SKIP_UPDATE: "false"
      SCANNER_TRIVY_GITHUB_TOKEN: ""
      SCANNER_TRIVY_INSECURE: "false"
      SCANNER_API_SERVER_ADDR: ":8080"
      SCANNER_STORE_REDIS_URL: redis://harbor-redis:6379/5
      SCANNER_JOB_QUEUE_REDIS_URL: redis://harbor-redis:6379/5
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/probe/healthy || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Nginx - Reverse Proxy
  # ============================================
  harbor-nginx:
    image: goharbor/nginx-photon:v2.10.0
    container_name: ${CONTAINER_PREFIX}-nginx
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
    depends_on:
      - harbor-core
      - harbor-portal
      - harbor-registry

    volumes:
      # Keep nginx config persistent (certs, conf.d) on a dedicated volume
      - harbor-nginx-config:/etc/nginx:z

    # Give nginx writable temp areas safely (RAM) to avoid permission issues
    tmpfs:
      - /etc/nginx/client_body_temp
      - /var/cache/nginx
      - /var/run

    networks:
      - harbor
      - web

    labels:
      - traefik.enable=true
      - traefik.http.routers.${CONTAINER_PREFIX}.rule=Host(`${REGISTRY_DOMAIN}`)
      - traefik.http.routers.${CONTAINER_PREFIX}.entrypoints=websecure
      - traefik.http.routers.${CONTAINER_PREFIX}.tls=true
      - traefik.http.routers.${CONTAINER_PREFIX}.tls.certresolver=mytlschallenge
      - traefik.http.services.${CONTAINER_PREFIX}.loadbalancer.server.port=8080

      - traefik.http.middlewares.${CONTAINER_PREFIX}-headers.headers.SSLRedirect=true
      - traefik.http.middlewares.${CONTAINER_PREFIX}-headers.headers.STSSeconds=315360000
      - traefik.http.middlewares.${CONTAINER_PREFIX}-headers.headers.browserXSSFilter=true
      - traefik.http.middlewares.${CONTAINER_PREFIX}-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.${CONTAINER_PREFIX}-headers.headers.forceSTSHeader=true
      - traefik.http.middlewares.${CONTAINER_PREFIX}-headers.headers.SSLHost=${REGISTRY_DOMAIN}
      - traefik.http.middlewares.${CONTAINER_PREFIX}-headers.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.${CONTAINER_PREFIX}-headers.headers.STSPreload=true
      - traefik.http.routers.${CONTAINER_PREFIX}.middlewares=${CONTAINER_PREFIX}-headers@docker

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  harbor-db:
    name: ${CONTAINER_PREFIX}_db_data
  harbor-redis:
    name: ${CONTAINER_PREFIX}_redis_data
  harbor-registry:
    name: ${CONTAINER_PREFIX}_registry_data
  harbor-config:
    name: ${CONTAINER_PREFIX}_config
  harbor-ca:
    name: ${CONTAINER_PREFIX}_ca
  harbor-psc:
    name: ${CONTAINER_PREFIX}_psc
  harbor-jobservice:
    name: ${CONTAINER_PREFIX}_jobservice
  harbor-trivy:
    name: ${CONTAINER_PREFIX}_trivy_cache
  harbor-registryctl-config:
    name: ${CONTAINER_PREFIX}_registryctl_config
  harbor-nginx-config:
    name: ${CONTAINER_PREFIX}_nginx_config

networks:
  harbor:
    name: ${NETWORK_NAME}
    driver: bridge
  web:
    external: true
